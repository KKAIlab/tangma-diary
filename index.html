<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç³–å¦ˆæ—¥è®° - å¦Šå¨ æœŸç³–å°¿ç—…ç®¡ç†</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="translations.js"></script>
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- Google API Client -->
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        :root {
            --primary: #FF6B9D;
            --primary-light: #FFE4EC;
            --primary-dark: #E84C7A;
            --success: #4ECDC4;
            --success-light: #E8FAF8;
            --warning: #FFB347;
            --warning-light: #FFF4E6;
            --danger: #FF6B6B;
            --danger-light: #FFE8E8;
            --text: #2D3436;
            --text-light: #636E72;
            --bg: #FFF9FB;
            --card: #FFFFFF;
            --border: #F0E6EA;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Noto Sans SC', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 90px;
        }
        .header-bg {
            position: fixed; top: 0; left: 0; right: 0; height: 180px;
            background: linear-gradient(135deg, var(--primary) 0%, #FF8FB1 100%);
            border-radius: 0 0 30px 30px;
            z-index: 0;
        }
        .container { position: relative; z-index: 1; max-width: 480px; margin: 0 auto; padding: 16px; }
        .header { color: white; padding: 8px 0 24px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .logo { font-size: 1.4rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .logo-icon { width: 32px; height: 32px; background: rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .header-btn { width: 36px; height: 36px; background: rgba(255,255,255,0.2); border: none; border-radius: 10px; color: white; font-size: 1.1rem; cursor: pointer; }
        .greeting { font-size: 1rem; opacity: 0.9; }

        /* è¯­è¨€åˆ‡æ¢å™¨ */
        .lang-switcher {
            display: flex;
            gap: 6px;
            background: rgba(255,255,255,0.2);
            padding: 4px;
            border-radius: 10px;
        }
        .lang-btn {
            padding: 6px 12px;
            background: transparent;
            border: none;
            color: white;
            font-size: 0.85rem;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.7;
        }
        .lang-btn.active {
            background: white;
            color: var(--primary);
            opacity: 1;
        }
        .lang-btn:hover {
            opacity: 1;
        }
        
        /* æ¦‚è§ˆå¡ç‰‡ */
        .overview-card {
            background: var(--card);
            border-radius: 20px;
            padding: 16px;
            margin-top: 8px;
            box-shadow: 0 8px 30px rgba(255,107,157,0.15);
        }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .stat-item { text-align: center; padding: 14px 10px; background: var(--bg); border-radius: 14px; }
        .stat-icon { width: 40px; height: 40px; margin: 0 auto 8px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .stat-icon.pink { background: var(--primary-light); }
        .stat-icon.green { background: var(--success-light); }
        .stat-icon.orange { background: var(--warning-light); }
        .stat-icon.blue { background: #E8F4FD; }
        .stat-value { font-size: 1.4rem; font-weight: 700; }
        .stat-value .unit { font-size: 0.75rem; font-weight: 400; color: var(--text-light); }
        .stat-label { font-size: 0.75rem; color: var(--text-light); margin-top: 2px; }
        
        /* æ—¥æœŸé€‰æ‹©å™¨ */
        .date-selector {
            display: flex; gap: 8px; overflow-x: auto; padding: 16px 0;
            margin: 0 -16px; padding-left: 16px; padding-right: 16px;
            scrollbar-width: none;
        }
        .date-selector::-webkit-scrollbar { display: none; }
        .date-item {
            flex-shrink: 0; width: 52px; padding: 10px 6px;
            background: var(--card); border: 2px solid var(--border);
            border-radius: 14px; text-align: center; cursor: pointer;
        }
        .date-item.active { background: var(--primary); border-color: var(--primary); color: white; }
        .date-item.has-data::after {
            content: ''; display: block; width: 5px; height: 5px;
            background: var(--success); border-radius: 50%; margin: 4px auto 0;
        }
        .date-item.active.has-data::after { background: white; }
        .date-weekday { font-size: 0.65rem; color: var(--text-light); margin-bottom: 2px; }
        .date-item.active .date-weekday { color: rgba(255,255,255,0.8); }
        .date-day { font-size: 1.1rem; font-weight: 700; }
        
        /* åŒºå— */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin: 20px 0 12px; }
        .section-title { font-size: 1rem; font-weight: 700; display: flex; align-items: center; gap: 6px; }
        .section-action { font-size: 0.8rem; color: var(--primary); text-decoration: none; font-weight: 500; }
        
        /* æ¯æ—¥æ€»ç»“ */
        .summary-card {
            background: linear-gradient(135deg, var(--primary) 0%, #FF8FB1 100%);
            border-radius: 18px; padding: 16px; color: white; margin-bottom: 16px;
        }
        .summary-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .summary-title { font-weight: 700; font-size: 1rem; }
        .summary-badge { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 16px; font-size: 0.75rem; }
        .summary-stats { display: flex; gap: 12px; }
        .summary-stat { flex: 1; text-align: center; padding: 10px; background: rgba(255,255,255,0.15); border-radius: 10px; }
        .summary-stat-value { font-size: 1.2rem; font-weight: 700; }
        .summary-stat-label { font-size: 0.7rem; opacity: 0.9; margin-top: 2px; }
        
        /* ä¸‰é¤å¡ç‰‡ */
        .meal-card {
            background: var(--card); border-radius: 18px; padding: 16px;
            box-shadow: 0 4px 20px rgba(255,107,157,0.1); margin-bottom: 12px;
        }
        .meal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .meal-info { display: flex; align-items: center; gap: 10px; }
        .meal-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; }
        .meal-icon.breakfast { background: linear-gradient(135deg, #FFE4B5 0%, #FFD700 100%); }
        .meal-icon.lunch { background: linear-gradient(135deg, #98FB98 0%, #32CD32 100%); }
        .meal-icon.dinner { background: linear-gradient(135deg, #DDA0DD 0%, #9370DB 100%); }
        .meal-name { font-weight: 700; font-size: 0.95rem; }
        .meal-time { font-size: 0.75rem; color: var(--text-light); }
        .glucose-value { font-size: 1.3rem; font-weight: 700; }
        .glucose-value.normal { color: var(--success); }
        .glucose-value.warning { color: var(--warning); }
        .glucose-value.high { color: var(--danger); }
        .glucose-label { font-size: 0.7rem; color: var(--text-light); text-align: right; }
        .meal-foods { background: var(--bg); border-radius: 10px; padding: 10px; margin-bottom: 10px; }
        .food-tags { display: flex; flex-wrap: wrap; gap: 6px; }
        .food-tag {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 5px 8px; background: white; border-radius: 16px;
            font-size: 0.75rem; border: 1px solid var(--border);
        }
        .gi-dot { width: 6px; height: 6px; border-radius: 50%; }
        .gi-dot.low { background: var(--success); }
        .gi-dot.medium { background: var(--warning); }
        .gi-dot.high { background: var(--danger); }
        .meal-analysis { display: flex; gap: 10px; padding-top: 10px; border-top: 1px dashed var(--border); }
        .analysis-item { flex: 1; text-align: center; padding: 6px; background: var(--bg); border-radius: 8px; }
        .analysis-value { font-size: 0.9rem; font-weight: 700; }
        .analysis-label { font-size: 0.65rem; color: var(--text-light); }
        
        /* å»ºè®®å¡ç‰‡ */
        .advice-card {
            background: var(--card); border-radius: 14px; padding: 14px;
            display: flex; gap: 12px; margin-bottom: 10px;
            box-shadow: 0 4px 20px rgba(255,107,157,0.1);
        }
        .advice-card.success { border-left: 4px solid var(--success); }
        .advice-card.warning { border-left: 4px solid var(--warning); }
        .advice-card.danger { border-left: 4px solid var(--danger); }
        .advice-card.info { border-left: 4px solid var(--primary); }
        .advice-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0; }
        .advice-card.success .advice-icon { background: var(--success-light); }
        .advice-card.warning .advice-icon { background: var(--warning-light); }
        .advice-card.danger .advice-icon { background: var(--danger-light); }
        .advice-card.info .advice-icon { background: var(--primary-light); }
        .advice-title { font-weight: 700; font-size: 0.9rem; margin-bottom: 2px; }
        .advice-text { font-size: 0.8rem; color: var(--text-light); line-height: 1.4; }
        
        /* GIæœç´¢ */
        .gi-search-card { background: var(--card); border-radius: 18px; padding: 16px; box-shadow: 0 4px 20px rgba(255,107,157,0.1); margin-bottom: 16px; }
        .search-wrapper { display: flex; gap: 10px; margin-bottom: 14px; }
        .search-input { flex: 1; padding: 12px 14px; border: 2px solid var(--border); border-radius: 12px; font-size: 0.95rem; font-family: inherit; }
        .search-input:focus { outline: none; border-color: var(--primary); }
        .camera-btn { width: 48px; height: 48px; background: var(--primary); border: none; border-radius: 12px; color: white; font-size: 1.2rem; cursor: pointer; }
        .gi-result-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg); border-radius: 10px; margin-bottom: 8px; }
        .gi-food-info { display: flex; align-items: center; gap: 10px; }
        .gi-food-icon { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
        .gi-food-icon.low { background: var(--success-light); }
        .gi-food-icon.medium { background: var(--warning-light); }
        .gi-food-icon.high { background: var(--danger-light); }
        .gi-food-name { font-weight: 500; font-size: 0.9rem; }
        .gi-food-category { font-size: 0.7rem; color: var(--text-light); }
        .gi-value { font-weight: 700; font-size: 1rem; }
        .gi-value.low { color: var(--success); }
        .gi-value.medium { color: var(--warning); }
        .gi-value.high { color: var(--danger); }
        .gl-value { font-size: 0.7rem; color: var(--text-light); }
        
        /* æŒ‡å— */
        .guide-card { background: var(--card); border-radius: 18px; padding: 16px; box-shadow: 0 4px 20px rgba(255,107,157,0.1); margin-bottom: 14px; }
        .guide-title { font-weight: 700; font-size: 0.95rem; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
        .guide-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .guide-table th, .guide-table td { padding: 8px 6px; text-align: left; border-bottom: 1px solid var(--border); }
        .guide-table th { color: var(--text-light); font-weight: 500; }
        .target-value { font-weight: 700; }
        .target-value.success { color: var(--success); }
        .target-value.warning { color: var(--warning); }
        .tip-box { margin-top: 10px; padding: 10px; border-radius: 8px; font-size: 0.8rem; }
        .tip-box.warning { background: var(--warning-light); }
        .tip-box.success { background: var(--success-light); }
        
        /* ç»Ÿè®¡å›¾è¡¨ */
        .chart-card { background: var(--card); border-radius: 18px; padding: 16px; box-shadow: 0 4px 20px rgba(255,107,157,0.1); margin-bottom: 14px; }
        .chart-title { font-weight: 700; font-size: 0.95rem; margin-bottom: 12px; }
        .chart-container { height: 180px; }
        .meal-avg-grid { display: flex; gap: 10px; margin-top: 14px; }
        .meal-avg-item { flex: 1; text-align: center; padding: 12px 8px; border-radius: 10px; }
        .meal-avg-value { font-size: 1.3rem; font-weight: 700; }
        .meal-avg-label { font-size: 0.7rem; color: var(--text-light); margin-top: 2px; }
        .meal-avg-status { font-size: 0.7rem; margin-top: 4px; }
        
        /* å‘¨æ•°æ®è¡¨æ ¼ */
        .week-table { overflow-x: auto; margin: 12px 0; }
        .week-table table { width: 100%; min-width: 500px; border-collapse: collapse; font-size: 0.75rem; }
        .week-table th, .week-table td { padding: 8px 5px; text-align: center; border: 1px solid var(--border); }
        .week-table th { background: var(--bg); font-weight: 600; color: var(--text-light); }
        .glucose-cell.normal { background: var(--success-light); color: #2a9d8f; font-weight: 600; }
        .glucose-cell.warning { background: var(--warning-light); color: #e68a00; font-weight: 600; }
        .glucose-cell.high { background: var(--danger-light); color: var(--danger); font-weight: 600; }
        
        /* åº•éƒ¨å¯¼èˆª */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--card); border-top: 1px solid var(--border);
            padding: 8px 16px 20px; display: flex; justify-content: space-around; z-index: 100;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 6px 14px; background: none; border: none; color: var(--text-light); font-size: 0.7rem; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 1.3rem; }
        .nav-add { width: 52px; height: 52px; background: var(--primary); border: none; border-radius: 50%; color: white; font-size: 1.6rem; cursor: pointer; margin-top: -26px; box-shadow: 0 4px 20px rgba(255,107,157,0.3); }
        
        /* æ¨¡æ€æ¡† */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: none; align-items: flex-end; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--card); border-radius: 20px 20px 0 0; width: 100%; max-width: 480px; max-height: 85vh; overflow-y: auto; padding: 20px; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .modal-title { font-size: 1.1rem; font-weight: 700; }
        .modal-close { width: 32px; height: 32px; background: var(--bg); border: none; border-radius: 50%; font-size: 1.1rem; cursor: pointer; }
        
        /* é¡µé¢åˆ‡æ¢ */
        .page { display: none; }
        .page.active { display: block; }
        .hidden-input { display: none; }
    </style>
</head>
<body>
    <div class="header-bg"></div>
    <div class="container">
        <!-- é¦–é¡µ -->
        <div class="page active" id="page-home">
            <div class="header">
                <div class="header-top">
                    <div class="logo"><div class="logo-icon">ğŸ¤°</div><span id="app-title">ç³–å¦ˆæ—¥è®°</span></div>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <div class="lang-switcher">
                            <button class="lang-btn active" onclick="switchLanguage('zh')" data-lang="zh">ä¸­æ–‡</button>
                            <button class="lang-btn" onclick="switchLanguage('ja')" data-lang="ja">æ—¥æœ¬èª</button>
                            <button class="lang-btn" onclick="switchLanguage('en')" data-lang="en">EN</button>
                        </div>
                        <button class="header-btn" onclick="showPage('page-guide')">ğŸ“‹</button>
                        <button class="header-btn" onclick="showPage('page-stats')">ğŸ“Š</button>
                    </div>
                </div>
                <div class="greeting" id="current-date">2025å¹´12æœˆ17æ—¥ å‘¨äºŒ</div>
            </div>
            
            <div class="overview-card">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-icon pink">ğŸ¯</div>
                        <div class="stat-value" id="compliance-rate">68%</div>
                        <div class="stat-label">æœ¬å‘¨è¾¾æ ‡ç‡</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon green">ğŸ“‰</div>
                        <div class="stat-value" id="avg-glucose">118<span class="unit">mg/dL</span></div>
                        <div class="stat-label">å¹³å‡é¤åè¡€ç³–</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon orange">âš–ï¸</div>
                        <div class="stat-value" id="weight-display">67.7<span class="unit">kg</span></div>
                        <div class="stat-label">ä»Šæ—¥ä½“é‡</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon blue">ğŸ‘£</div>
                        <div class="stat-value" id="steps-display">5144<span class="unit">æ­¥</span></div>
                        <div class="stat-label">ä»Šæ—¥æ­¥æ•°</div>
                    </div>
                </div>
            </div>
            
            <div class="date-selector" id="date-selector"></div>
            
            <div class="summary-card" id="daily-summary">
                <div class="summary-header">
                    <div class="summary-title">ğŸ“Š ä»Šæ—¥å°ç»“</div>
                    <div class="summary-badge" id="summary-badge">éœ€è¦å…³æ³¨</div>
                </div>
                <div class="summary-stats">
                    <div class="summary-stat">
                        <div class="summary-stat-value" id="summary-meals">3</div>
                        <div class="summary-stat-label">è®°å½•é¤æ•°</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-value" id="summary-normal">2</div>
                        <div class="summary-stat-label">è¾¾æ ‡æ¬¡æ•°</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-value" id="summary-high">1</div>
                        <div class="summary-stat-label">è¶…æ ‡æ¬¡æ•°</div>
                    </div>
                </div>
            </div>
            
            <div class="section-header">
                <div class="section-title">ğŸ½ï¸ ä»Šæ—¥é¥®é£Ÿ</div>
                <a href="#" class="section-action" onclick="showModal('add-meal-modal')">+ æ·»åŠ </a>
            </div>
            <div id="meal-cards"></div>
            
            <div class="section-header">
                <div class="section-title">ğŸ’¡ ä»Šæ—¥å»ºè®®</div>
            </div>
            <div id="advice-cards"></div>
        </div>
        
        <!-- GIæŸ¥è¯¢é¡µé¢ -->
        <div class="page" id="page-gi">
            <div class="header">
                <div class="header-top">
                    <div class="logo"><div class="logo-icon">ğŸ”</div><span>é£Ÿç‰©GIæŸ¥è¯¢</span></div>
                </div>
                <div class="greeting">æŸ¥è¯¢é£Ÿç‰©çš„å‡ç³–æŒ‡æ•°</div>
            </div>
            
            <div class="gi-search-card">
                <div class="search-wrapper">
                    <input type="text" class="search-input" id="gi-search-input" placeholder="è¾“å…¥é£Ÿç‰©åç§°æœç´¢...">
                    <button class="camera-btn" onclick="showModal('photo-modal')">ğŸ“·</button>
                </div>
                <div id="gi-results"></div>
            </div>
            
            <div class="guide-card">
                <div class="guide-title">ğŸ“š GIå€¼åˆ†ç±»æ ‡å‡†</div>
                <table class="guide-table">
                    <tr><th>åˆ†ç±»</th><th>GIå€¼</th><th>å»ºè®®</th></tr>
                    <tr><td><span style="color:var(--success);">â—</span> ä½GI</td><td class="target-value success">â‰¤55</td><td>ä¼˜å…ˆé€‰æ‹©</td></tr>
                    <tr><td><span style="color:var(--warning);">â—</span> ä¸­GI</td><td class="target-value warning">56-70</td><td>é€‚é‡é£Ÿç”¨</td></tr>
                    <tr><td><span style="color:var(--danger);">â—</span> é«˜GI</td><td class="target-value" style="color:var(--danger);">>70</td><td>å°½é‡é¿å…</td></tr>
                </table>
            </div>
            
            <div class="section-header"><div class="section-title">â­ å¸¸è§é£Ÿç‰©</div></div>
            <div class="gi-search-card"><div id="common-foods"></div></div>
        </div>
        
        <!-- æŒ‡å—é¡µé¢ -->
        <div class="page" id="page-guide">
            <div class="header">
                <div class="header-top">
                    <div class="logo"><div class="logo-icon">ğŸ“‹</div><span>æ§ç³–æŒ‡å—</span></div>
                </div>
                <div class="greeting">åŸºäºä¸­æ—¥ç¾ä¸´åºŠæŒ‡å—</div>
            </div>
            
            <div class="guide-card">
                <div class="guide-title">ğŸ¯ è¡€ç³–æ§åˆ¶ç›®æ ‡</div>
                <table class="guide-table">
                    <tr><th>ç›‘æµ‹æ—¶é—´</th><th>ç›®æ ‡å€¼</th><th>æ‚¨çš„å‡å€¼</th></tr>
                    <tr><td>ç©ºè…¹è¡€ç³–</td><td class="target-value success">&lt;95 mg/dL</td><td id="guide-fasting">88</td></tr>
                    <tr><td>é¤å1å°æ—¶</td><td class="target-value success">&lt;140 mg/dL</td><td>-</td></tr>
                    <tr><td>é¤å2å°æ—¶</td><td class="target-value success">&lt;120 mg/dL</td><td id="guide-postmeal">118</td></tr>
                </table>
            </div>
            
            <div class="guide-card">
                <div class="guide-title">ğŸš æ¯æ—¥ç¢³æ°´åˆ†é…</div>
                <table class="guide-table">
                    <tr><th>é¤æ¬¡</th><th>çƒ­é‡å æ¯”</th><th>ç¢³æ°´å»ºè®®</th></tr>
                    <tr><td>æ—©é¤ ğŸŒ…</td><td>10-15%</td><td class="target-value warning">15-30g</td></tr>
                    <tr><td>åˆé¤ â˜€ï¸</td><td>30%</td><td class="target-value">45-60g</td></tr>
                    <tr><td>æ™šé¤ ğŸŒ™</td><td>30%</td><td class="target-value">45-60g</td></tr>
                    <tr><td>åŠ é¤ ğŸ</td><td>5-10%</td><td class="target-value">15-30g</td></tr>
                </table>
                <div class="tip-box warning">âš ï¸ <strong>æ—©é¤æç¤º</strong>ï¼šæ¸…æ™¨çš®è´¨é†‡è¾ƒé«˜ï¼Œè¡€ç³–æ›´éš¾æ§åˆ¶ã€‚å»ºè®®æ—©é¤ç¢³æ°´æ§åˆ¶åœ¨15-20gï¼Œé¿å…æ°´æœå’Œæœæ±ã€‚</div>
            </div>
            
            <div class="guide-card">
                <div class="guide-title">ğŸƒâ€â™€ï¸ è¿åŠ¨å»ºè®®</div>
                <table class="guide-table">
                    <tr><th>é¡¹ç›®</th><th>æ¨èå€¼</th></tr>
                    <tr><td>æ¯å‘¨è¿åŠ¨æ—¶é—´</td><td class="target-value success">â‰¥150åˆ†é’Ÿ</td></tr>
                    <tr><td>æ¯æ—¥æ­¥æ•°ç›®æ ‡</td><td class="target-value success">â‰¥6000æ­¥</td></tr>
                    <tr><td>é¤åè¿åŠ¨æ—¶æœº</td><td class="target-value">é¤å15åˆ†é’Ÿå¼€å§‹</td></tr>
                    <tr><td>æ¯æ¬¡è¿åŠ¨æ—¶é•¿</td><td class="target-value">20-30åˆ†é’Ÿ</td></tr>
                </table>
                <div class="tip-box success">âœ… <strong>é¤åæ•£æ­¥</strong>ï¼šç ”ç©¶æ˜¾ç¤ºé¤å20åˆ†é’Ÿæ•£æ­¥å¯ä½¿è¡€ç³–å¹³å‡ä¸‹é™0.22 mmol/L</div>
            </div>
            
            <div class="guide-card">
                <div class="guide-title">â° æ™ºèƒ½æé†’</div>
                <div class="tip-box" style="background:linear-gradient(135deg,#E8F4FD 0%,#D6EAF8 100%);border-color:#3498DB;">
                    ğŸ’¡ <strong>é¤åè¡€ç³–æµ‹é‡æé†’</strong>ï¼šåœ¨æ‚¨è®°å½•ç”¨é¤æ—¶é—´åï¼Œæˆ‘ä»¬ä¼šåœ¨é¤å1å°æ—¶å’Œ2å°æ—¶æé†’æ‚¨æµ‹è¡€ç³–ã€‚
                </div>
                <div style="margin-top:12px;">
                    <button id="enable-notification-btn" onclick="toggleNotification()" style="width:100%;padding:12px;background:var(--primary);color:white;border:none;border-radius:10px;font-size:0.9rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;">
                        <span style="font-size:1.2rem;">ğŸ””</span>
                        <span id="notification-btn-text">å¼€å¯é¤åæé†’</span>
                    </button>
                </div>
                <div style="margin-top:10px;padding:10px;background:var(--bg);border-radius:8px;font-size:0.75rem;color:var(--text-light);">
                    <div style="margin-bottom:6px;"><strong>æé†’æ—¶é—´ï¼š</strong></div>
                    <div>â€¢ é¤å1å°æ—¶æé†’ï¼ˆç›®æ ‡ï¼š<140 mg/dLï¼‰</div>
                    <div>â€¢ é¤å2å°æ—¶æé†’ï¼ˆç›®æ ‡ï¼š<120 mg/dLï¼‰</div>
                </div>
            </div>

            <div class="guide-card">
                <div class="guide-title">ğŸ’¾ æ•°æ®ç®¡ç†</div>

                <!-- Google Drive äº‘ç«¯åŒæ­¥ -->
                <div id="google-drive-section" style="background:linear-gradient(135deg,#E8F5E9 0%,#C8E6C9 100%);border-radius:12px;padding:14px;margin-bottom:12px;">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span style="font-size:1.3rem;">â˜ï¸</span>
                            <span style="font-weight:600;color:#2E7D32;">Google Drive äº‘ç«¯åŒæ­¥</span>
                        </div>
                        <div id="sync-status-badge" style="font-size:0.7rem;padding:4px 8px;background:#4CAF50;color:white;border-radius:12px;display:none;">
                            âœ“ å·²è¿æ¥
                        </div>
                    </div>
                    <div id="google-drive-not-connected" style="margin-bottom:10px;">
                        <div style="font-size:0.8rem;color:#558B2F;margin-bottom:10px;line-height:1.5;">
                            è¿æ¥Google Driveåï¼Œæ•°æ®å°†è‡ªåŠ¨å¤‡ä»½åˆ°äº‘ç«¯ï¼Œå¤šè®¾å¤‡æ— ç¼åŒæ­¥
                        </div>
                        <button onclick="connectGoogleDrive()" style="width:100%;padding:12px;background:#4CAF50;color:white;border:none;border-radius:10px;font-size:0.9rem;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="white">
                                <path d="M12.545 10.239v3.821h5.445c-.712 2.315-2.647 3.972-5.445 3.972a6.033 6.033 0 110-12.064c1.498 0 2.866.549 3.921 1.453l2.814-2.814A9.969 9.969 0 0012.545 2C7.021 2 2.543 6.477 2.543 12s4.478 10 10.002 10c8.396 0 10.249-7.85 9.426-11.748l-9.426-.013z"/>
                            </svg>
                            <span>è¿æ¥ Google Drive</span>
                        </button>
                    </div>
                    <div id="google-drive-connected" style="display:none;">
                        <div style="font-size:0.75rem;color:#558B2F;margin-bottom:10px;">
                            <div>ğŸ“§ <span id="user-email"></span></div>
                            <div style="margin-top:4px;">ğŸ•’ æœ€ååŒæ­¥ï¼š<span id="last-sync-time">ä»æœª</span></div>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                            <button onclick="manualSyncToDrive()" style="padding:10px;background:white;color:#4CAF50;border:2px solid #4CAF50;border-radius:8px;font-size:0.8rem;cursor:pointer;font-weight:600;">
                                â†‘ ç«‹å³å¤‡ä»½
                            </button>
                            <button onclick="manualSyncFromDrive()" style="padding:10px;background:white;color:#4CAF50;border:2px solid #4CAF50;border-radius:8px;font-size:0.8rem;cursor:pointer;font-weight:600;">
                                â†“ æ¢å¤æ•°æ®
                            </button>
                        </div>
                        <button onclick="disconnectGoogleDrive()" style="width:100%;margin-top:8px;padding:8px;background:white;color:#D32F2F;border:1px solid #D32F2F;border-radius:8px;font-size:0.75rem;cursor:pointer;">
                            æ–­å¼€è¿æ¥
                        </button>
                    </div>
                </div>

                <!-- æœ¬åœ°æ•°æ®ç®¡ç† -->
                <div style="font-weight:600;color:var(--text-light);font-size:0.8rem;margin-bottom:8px;">ğŸ“± æœ¬åœ°æ•°æ®ç®¡ç†</div>
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:10px;">
                    <button onclick="exportData()" style="padding:12px;background:var(--primary);color:white;border:none;border-radius:10px;font-size:0.85rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;">
                        <span style="font-size:1.1rem;">ğŸ“¤</span><span>å¯¼å‡ºæ•°æ®</span>
                    </button>
                    <button onclick="document.getElementById('import-file').click()" style="padding:12px;background:var(--success);color:white;border:none;border-radius:10px;font-size:0.85rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;">
                        <span style="font-size:1.1rem;">ğŸ“¥</span><span>å¯¼å…¥æ•°æ®</span>
                    </button>
                </div>
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:10px;">
                    <button onclick="loadSampleData()" style="padding:10px;background:var(--warning-light);color:var(--warning);border:2px solid var(--warning);border-radius:10px;font-size:0.85rem;cursor:pointer;">
                        ğŸ”„ æ¢å¤ç¤ºä¾‹æ•°æ®
                    </button>
                    <button onclick="clearAllData()" style="padding:10px;background:var(--danger-light);color:var(--danger);border:2px solid var(--danger);border-radius:10px;font-size:0.85rem;cursor:pointer;">
                        ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æ•°æ®
                    </button>
                </div>
                <input type="file" id="import-file" accept=".json" style="display:none;" onchange="importData(this.files[0])">
                <div style="margin-top:12px;padding:10px;background:var(--bg);border-radius:8px;font-size:0.75rem;color:var(--text-light);">
                    ğŸ’¡ <strong>æç¤ºï¼š</strong>å®šæœŸå¯¼å‡ºæ•°æ®å¤‡ä»½ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±ã€‚å¯¼å‡ºçš„JSONæ–‡ä»¶å¯åœ¨å…¶ä»–è®¾å¤‡å¯¼å…¥ã€‚
                </div>
                <div style="margin-top:8px;padding:8px;background:var(--warning-light);border-radius:8px;font-size:0.75rem;color:var(--text);">
                    ğŸ”„ <strong>æ¢å¤ç¤ºä¾‹æ•°æ®</strong>ï¼šç”¨äºæµ‹è¯•æˆ–å­¦ä¹ åº”ç”¨åŠŸèƒ½ï¼Œä¼šåŠ è½½2å‘¨çš„ç¤ºä¾‹è®°å½•ã€‚
                </div>
            </div>

            <div class="guide-card" id="japan-medical-terms">
                <div class="guide-title">ğŸ¥ æ—¥æœ¬åŒ»ç–—æœ¯è¯­å¯¹ç…§è¡¨</div>
                <div class="tip-box" style="background:linear-gradient(135deg,#FFF4E6 0%,#FFE8CC 100%);border-color:var(--warning);">
                    ğŸ‡¯ğŸ‡µ <strong>åœ¨æ—¥å°±åŒ»å¿…å¤‡</strong>ï¼šé¢å‘åœ¨æ—¥æœ¬äº§æ£€å’Œç”Ÿäº§çš„å‡†å¦ˆå¦ˆï¼Œå¸®åŠ©æ‚¨ç†è§£æ—¥æœ¬åŒ»é™¢çš„åŒ»å­¦æœ¯è¯­å’Œæ£€æŸ¥é¡¹ç›®ã€‚
                </div>

                <!-- åŒ»ç–—æœºæ„ -->
                <div style="margin:16px 0;">
                    <div style="font-size:0.9rem;font-weight:600;margin-bottom:8px;color:var(--primary);">ğŸ“ å¸¸ç”¨åŒ»ç–—æœºæ„</div>
                    <table class="guide-table">
                        <tr><th>æ—¥æœ¬èª</th><th>ä¸­æ–‡</th><th>English</th></tr>
                        <tr><td><ruby>ç”£å©¦äººç§‘<rt>ã•ã‚“ãµã˜ã‚“ã‹</rt></ruby></td><td>å¦‡äº§ç§‘</td><td>OB/GYN</td></tr>
                        <tr><td><ruby>ç·åˆç—…é™¢<rt>ãã†ã”ã†ã³ã‚‡ã†ã„ã‚“</rt></ruby></td><td>ç»¼åˆåŒ»é™¢</td><td>General Hospital</td></tr>
                        <tr><td>ã‚¯ãƒªãƒ‹ãƒƒã‚¯</td><td>è¯Šæ‰€</td><td>Clinic</td></tr>
                        <tr><td><ruby>åŠ©ç”£é™¢<rt>ã˜ã‚‡ã•ã‚“ã„ã‚“</rt></ruby></td><td>åŠ©äº§é™¢</td><td>Midwifery Clinic</td></tr>
                        <tr><td><ruby>å€‹äººç—…é™¢<rt>ã“ã˜ã‚“ã³ã‚‡ã†ã„ã‚“</rt></ruby></td><td>ç§ç«‹åŒ»é™¢</td><td>Private Hospital</td></tr>
                    </table>
                </div>

                <!-- æ£€æŸ¥é¡¹ç›® -->
                <div style="margin:16px 0;">
                    <div style="font-size:0.9rem;font-weight:600;margin-bottom:8px;color:var(--primary);">ğŸ”¬ å¸¸è§æ£€æŸ¥é¡¹ç›®</div>
                    <table class="guide-table">
                        <tr><th>æ—¥æœ¬èª</th><th>ä¸­æ–‡</th><th>è¯´æ˜</th></tr>
                        <tr><td><ruby>å¦Šå©¦å¥è¨º<rt>ã«ã‚“ã·ã‘ã‚“ã—ã‚“</rt></ruby></td><td>äº§æ£€</td><td>å®šæœŸå­•æœŸæ£€æŸ¥</td></tr>
                        <tr><td><ruby>è¡€æ¶²æ¤œæŸ»<rt>ã‘ã¤ãˆãã‘ã‚“ã•</rt></ruby></td><td>è¡€æ¶²æ£€æŸ¥</td><td>æŠ½è¡€åŒ–éªŒ</td></tr>
                        <tr><td><ruby>å°¿æ¤œæŸ»<rt>ã«ã‚‡ã†ã‘ã‚“ã•</rt></ruby></td><td>å°¿æ£€</td><td>å°¿æ¶²æ£€æŸ¥</td></tr>
                        <tr><td><ruby>çµŒå£<rt>ã‘ã„ã“ã†</rt></ruby>ãƒ–ãƒ‰ã‚¦<ruby>ç³–<rt>ã¨ã†</rt></ruby><ruby>è² è·è©¦é¨“<rt>ãµã‹ã—ã‘ã‚“</rt></ruby></td><td>OGTT</td><td>å£æœè‘¡è„ç³–è€é‡è¯•éªŒ</td></tr>
                        <tr><td><ruby>è¶…éŸ³æ³¢æ¤œæŸ»<rt>ã¡ã‚‡ã†ãŠã‚“ã±ã‘ã‚“ã•</rt></ruby></td><td>è¶…å£°æ³¢æ£€æŸ¥</td><td>Bè¶…</td></tr>
                        <tr><td><ruby>èƒå…å¿ƒæ‹<rt>ãŸã„ã˜ã—ã‚“ã±ã</rt></ruby></td><td>èƒå¿ƒç›‘æµ‹</td><td>ç›‘å¬èƒå„¿å¿ƒè·³</td></tr>
                    </table>
                </div>

                <!-- è¡€ç³–ç›¸å…³ -->
                <div style="margin:16px 0;">
                    <div style="font-size:0.9rem;font-weight:600;margin-bottom:8px;color:var(--primary);">ğŸ©¸ è¡€ç³–å€¼ç›¸å…³æœ¯è¯­</div>
                    <table class="guide-table">
                        <tr><th>æ—¥æœ¬èª</th><th>ä¸­æ–‡</th><th>ç›®æ ‡å€¼</th></tr>
                        <tr><td><ruby>ç©ºè…¹æ™‚<rt>ãã†ãµãã˜</rt></ruby><ruby>è¡€ç³–å€¤<rt>ã‘ã£ã¨ã†ã¡</rt></ruby></td><td>ç©ºè…¹è¡€ç³–å€¼</td><td class="target-value success">&lt;92 mg/dL</td></tr>
                        <tr><td><ruby>é£Ÿå¾Œ<rt>ã—ã‚‡ãã”</rt></ruby><ruby>è¡€ç³–å€¤<rt>ã‘ã£ã¨ã†ã¡</rt></ruby></td><td>é¤åè¡€ç³–å€¼</td><td class="target-value success">1h&lt;140<br>2h&lt;120</td></tr>
                        <tr><td>ãƒ˜ãƒ¢ã‚°ãƒ­ãƒ“ãƒ³A1c</td><td>ç³–åŒ–è¡€çº¢è›‹ç™½</td><td class="target-value success">&lt;5.8%</td></tr>
                        <tr><td><ruby>ä½è¡€ç³–<rt>ã¦ã„ã‘ã£ã¨ã†</rt></ruby></td><td>ä½è¡€ç³–</td><td class="target-value danger">&lt;70 mg/dL</td></tr>
                        <tr><td><ruby>é«˜è¡€ç³–<rt>ã“ã†ã‘ã£ã¨ã†</rt></ruby></td><td>é«˜è¡€ç³–</td><td class="target-value danger">&gt;180 mg/dL</td></tr>
                        <tr><td><ruby>å¦Šå¨ <rt>ã«ã‚“ã—ã‚“</rt></ruby>ç³–<ruby>å°¿ç—…<rt>ã«ã‚‡ã†ã³ã‚‡ã†</rt></ruby></td><td>å¦Šå¨ ç³–å°¿ç—…</td><td>GDM</td></tr>
                    </table>
                </div>

                <!-- æ²»ç–—æ–¹å¼ -->
                <div style="margin:16px 0;">
                    <div style="font-size:0.9rem;font-weight:600;margin-bottom:8px;color:var(--primary);">ğŸ’Š æ²»ç–—æ–¹å¼</div>
                    <table class="guide-table">
                        <tr><th>æ—¥æœ¬èª</th><th>ä¸­æ–‡</th><th>English</th></tr>
                        <tr><td><ruby>é£Ÿäº‹ç™‚æ³•<rt>ã—ã‚‡ãã˜ã‚Šã‚‡ã†ã»ã†</rt></ruby></td><td>é¥®é£Ÿç–—æ³•</td><td>Diet Therapy</td></tr>
                        <tr><td><ruby>é‹å‹•ç™‚æ³•<rt>ã†ã‚“ã©ã†ã‚Šã‚‡ã†ã»ã†</rt></ruby></td><td>è¿åŠ¨ç–—æ³•</td><td>Exercise Therapy</td></tr>
                        <tr><td>ã‚¤ãƒ³ã‚¹ãƒªãƒ³<ruby>ç™‚æ³•<rt>ã‚Šã‚‡ã†ã»ã†</rt></ruby></td><td>èƒ°å²›ç´ æ²»ç–—</td><td>Insulin Therapy</td></tr>
                        <tr><td><ruby>è¡€ç³–<rt>ã‘ã£ã¨ã†</rt></ruby><ruby>è‡ªå·±æ¸¬å®š<rt>ã˜ã“ããã¦ã„</rt></ruby></td><td>è¡€ç³–è‡ªæˆ‘ç›‘æµ‹</td><td>SMBG</td></tr>
                        <tr><td><ruby>è–¬ç‰©ç™‚æ³•<rt>ã‚„ãã¶ã¤ã‚Šã‚‡ã†ã»ã†</rt></ruby></td><td>è¯ç‰©æ²»ç–—</td><td>Medical Treatment</td></tr>
                    </table>
                </div>

                <!-- å¸¸ç”¨è¡¨è¾¾ -->
                <div style="margin:16px 0;">
                    <div style="font-size:0.9rem;font-weight:600;margin-bottom:8px;color:var(--primary);">ğŸ’¬ å°±åŒ»å¸¸ç”¨è¡¨è¾¾</div>
                    <div style="background:var(--bg);border-radius:10px;padding:12px;">
                        <div style="padding:8px 0;border-bottom:1px solid var(--border);">
                            <div style="font-weight:500;"><ruby>äºˆç´„<rt>ã‚ˆã‚„ã</rt></ruby>ã‚’ãŠ<ruby>é¡˜<rt>ã­ãŒ</rt></ruby>ã„ã—ã¾ã™</div>
                            <div style="font-size:0.8rem;color:var(--text-light);margin-top:2px;">æˆ‘è¦é¢„çº¦</div>
                        </div>
                        <div style="padding:8px 0;border-bottom:1px solid var(--border);">
                            <div style="font-weight:500;"><ruby>è¡€ç³–å€¤<rt>ã‘ã£ã¨ã†ã¡</rt></ruby>ãŒ<ruby>é«˜<rt>ãŸã‹</rt></ruby>ã„ã§ã™</div>
                            <div style="font-size:0.8rem;color:var(--text-light);margin-top:2px;">è¡€ç³–å€¼é«˜äº†</div>
                        </div>
                        <div style="padding:8px 0;border-bottom:1px solid var(--border);">
                            <div style="font-weight:500;"><ruby>æ°—åˆ†<rt>ãã¶ã‚“</rt></ruby>ãŒ<ruby>æ‚ª<rt>ã‚ã‚‹</rt></ruby>ã„ã§ã™</div>
                            <div style="font-size:0.8rem;color:var(--text-light);margin-top:2px;">æˆ‘æ„Ÿè§‰ä¸èˆ’æœ</div>
                        </div>
                        <div style="padding:8px 0;border-bottom:1px solid var(--border);">
                            <div style="font-weight:500;"><ruby>æ¯å­æ‰‹å¸³<rt>ã¼ã—ã¦ã¡ã‚‡ã†</rt></ruby>ã‚’<ruby>æŒ<rt>ã‚‚</rt></ruby>ã£ã¦ãã¾ã—ãŸ</div>
                            <div style="font-size:0.8rem;color:var(--text-light);margin-top:2px;">æˆ‘å¸¦äº†æ¯å­å¥åº·æ‰‹å†Œ</div>
                        </div>
                        <div style="padding:8px 0;border-bottom:1px solid var(--border);">
                            <div style="font-weight:500;"><ruby>é ­<rt>ã‚ãŸã¾</rt></ruby>ãŒ<ruby>ç—›<rt>ã„ãŸ</rt></ruby>ã„ã§ã™</div>
                            <div style="font-size:0.8rem;color:var(--text-light);margin-top:2px;">æˆ‘å¤´ç–¼</div>
                        </div>
                        <div style="padding:8px 0;">
                            <div style="font-weight:500;"><ruby>å<rt>ã¯</rt></ruby>ã<ruby>æ°—<rt>ã‘</rt></ruby>ãŒã—ã¾ã™</div>
                            <div style="font-size:0.8rem;color:var(--text-light);margin-top:2px;">æˆ‘æƒ³å</div>
                        </div>
                    </div>
                </div>

                <!-- æ—¥æœ¬äº§æ£€æ—¶é—´è¡¨ -->
                <div style="margin:16px 0;">
                    <div style="font-size:0.9rem;font-weight:600;margin-bottom:8px;color:var(--primary);">ğŸ“… æ—¥æœ¬äº§æ£€æ—¶é—´è¡¨ï¼ˆå‚è€ƒï¼‰</div>
                    <table class="guide-table">
                        <tr><th>å­•å‘¨</th><th>æ£€æŸ¥é¢‘ç‡</th><th>æ—¥æœ¬èª</th></tr>
                        <tr><td>~23å‘¨</td><td>æ¯4å‘¨ä¸€æ¬¡</td><td><ruby>4é€±<rt>ã‚ˆã‚“ã—ã‚…ã†</rt></ruby>ã«<ruby>1å›<rt>ã„ã£ã‹ã„</rt></ruby></td></tr>
                        <tr><td>24~35å‘¨</td><td>æ¯2å‘¨ä¸€æ¬¡</td><td><ruby>2é€±<rt>ã«ã—ã‚…ã†</rt></ruby>ã«<ruby>1å›<rt>ã„ã£ã‹ã„</rt></ruby></td></tr>
                        <tr><td>36å‘¨~åˆ†å¨©</td><td>æ¯å‘¨ä¸€æ¬¡</td><td><ruby>æ¯é€±<rt>ã¾ã„ã—ã‚…ã†</rt></ruby><ruby>1å›<rt>ã„ã£ã‹ã„</rt></ruby></td></tr>
                    </table>
                    <div class="tip-box warning" style="margin-top:10px;">
                        âš ï¸ <strong>GDMæ‚£è€…æ³¨æ„</strong>ï¼š<ruby>å¦Šå¨ <rt>ã«ã‚“ã—ã‚“</rt></ruby>ç³–<ruby>å°¿ç—…<rt>ã«ã‚‡ã†ã³ã‚‡ã†</rt></ruby><ruby>æ‚£è€…<rt>ã‹ã‚“ã˜ã‚ƒ</rt></ruby>å¯èƒ½éœ€è¦æ›´é¢‘ç¹çš„æ£€æŸ¥ï¼Œè¯·éµåŒ»å˜±ã€‚
                    </div>
                </div>
            </div>

            <div class="guide-card">
                <div class="guide-title">ğŸ“– è¿›é¤é¡ºåº</div>
                <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;padding:8px 0;">
                    <span style="background:var(--success-light);padding:6px 12px;border-radius:16px;font-size:0.85rem;">1ï¸âƒ£ è”¬èœ</span>
                    <span style="font-size:1.1rem;">â†’</span>
                    <span style="background:var(--primary-light);padding:6px 12px;border-radius:16px;font-size:0.85rem;">2ï¸âƒ£ è›‹ç™½è´¨</span>
                    <span style="font-size:1.1rem;">â†’</span>
                    <span style="background:var(--warning-light);padding:6px 12px;border-radius:16px;font-size:0.85rem;">3ï¸âƒ£ ä¸»é£Ÿ</span>
                </div>
                <div style="color:var(--text-light);font-size:0.8rem;margin-top:6px;">å…ˆåƒè”¬èœå’Œè›‹ç™½è´¨å¯å‡ç¼“ç¢³æ°´å¸æ”¶ï¼Œé™ä½è¡€ç³–å³°å€¼</div>
            </div>
        </div>
        
        <!-- ç»Ÿè®¡é¡µé¢ -->
        <div class="page" id="page-stats">
            <div class="header">
                <div class="header-top">
                    <div class="logo"><div class="logo-icon">ğŸ“Š</div><span>æ•°æ®ç»Ÿè®¡</span></div>
                </div>
                <div class="greeting">12æœˆ5æ—¥ - 12æœˆ17æ—¥ å‘¨æŠ¥</div>
            </div>
            
            <div class="chart-card">
                <div class="chart-title">ğŸ“ˆ é¤åè¡€ç³–è¶‹åŠ¿</div>
                <div class="chart-container"><canvas id="glucose-chart"></canvas></div>
            </div>
            
            <div class="chart-card">
                <div class="chart-title">ğŸ½ï¸ ä¸‰é¤è¡€ç³–åˆ†æ</div>
                <div class="meal-avg-grid">
                    <div class="meal-avg-item" style="background:var(--warning-light);">
                        <div class="meal-avg-value" style="color:var(--warning);" id="breakfast-avg">127</div>
                        <div class="meal-avg-label">æ—©é¤åå‡å€¼</div>
                        <div class="meal-avg-status" style="color:var(--danger);">âš ï¸ åé«˜</div>
                    </div>
                    <div class="meal-avg-item" style="background:var(--warning-light);">
                        <div class="meal-avg-value" style="color:var(--warning);" id="lunch-avg">121</div>
                        <div class="meal-avg-label">åˆé¤åå‡å€¼</div>
                        <div class="meal-avg-status" style="color:var(--warning);">âš¡ ä¸´ç•Œ</div>
                    </div>
                    <div class="meal-avg-item" style="background:var(--success-light);">
                        <div class="meal-avg-value" style="color:var(--success);" id="dinner-avg">109</div>
                        <div class="meal-avg-label">æ™šé¤åå‡å€¼</div>
                        <div class="meal-avg-status" style="color:var(--success);">âœ“ è¾¾æ ‡</div>
                    </div>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-title">ğŸ“‹ æ¯æ—¥è¯¦ç»†æ•°æ®</div>
                <div class="week-table">
                    <table>
                        <thead><tr><th>æ—¥æœŸ</th><th>ä½“é‡</th><th>æ—©é¤å</th><th>åˆé¤å</th><th>æ™šé¤å</th><th>æ­¥æ•°</th></tr></thead>
                        <tbody id="week-table-body"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="section-header"><div class="section-title">ğŸ’¡ ä¸ªæ€§åŒ–é£Ÿç‰©æ´å¯Ÿ</div></div>
            <div id="food-insights-container">
                <!-- åŠ¨æ€ç”Ÿæˆé£Ÿç‰©æ´å¯Ÿ -->
            </div>

            <div class="section-header"><div class="section-title">ğŸ” å…³é”®å‘ç°</div></div>
            <div class="advice-card warning">
                <div class="advice-icon">ğŸ³</div>
                <div><div class="advice-title">æ—©é¤è¡€ç³–æ§åˆ¶éœ€åŠ å¼º</div><div class="advice-text">æ—©é¤åè¡€ç³–å¹³å‡127mg/dLï¼Œè¶…æ ‡ç‡è¾¾60%ã€‚é¥ºå­ã€é¢åŒ…æ˜¯ä¸»è¦ç¢³æ°´æ¥æºï¼Œå»ºè®®å‡é‡æˆ–æ›¿æ¢ä¸ºä½GIé£Ÿç‰©ã€‚</div></div>
            </div>
            <div class="advice-card success">
                <div class="advice-icon">ğŸŒ™</div>
                <div><div class="advice-title">æ™šé¤æ§åˆ¶è‰¯å¥½</div><div class="advice-text">æ™šé¤åè¡€ç³–å¹³å‡109mg/dLï¼Œè¾¾æ ‡ç‡85%ã€‚ç„ç±³+è›‹ç™½è´¨+è”¬èœçš„æ­é…æ•ˆæœæ˜æ˜¾ï¼Œè¯·ç»§ç»­ä¿æŒï¼</div></div>
            </div>
            <div class="advice-card danger">
                <div class="advice-icon">ğŸš¶</div>
                <div><div class="advice-title">è¿åŠ¨é‡ä¸è¶³</div><div class="advice-text">æœ¬å‘¨å¹³å‡æ­¥æ•°5802æ­¥ï¼Œä½äº6000æ­¥ç›®æ ‡ã€‚11æ—¥ã€12æ—¥è®°å½•"æ²¡è¿åŠ¨"ï¼Œé¤åè¡€ç³–æ˜æ˜¾åé«˜ã€‚</div></div>
            </div>
            <div class="advice-card info">
                <div class="advice-icon">âš ï¸</div>
                <div><div class="advice-title">é»‘ä¾¿éœ€å…³æ³¨</div><div class="advice-text">7æ—¥ã€9æ—¥å‡ºç°é»‘è‰²å¤§ä¾¿ï¼Œå¯èƒ½ä¸è¡¥é“å‰‚æˆ–é¥®é£Ÿæœ‰å…³ã€‚å¦‚æŒç»­å‡ºç°è¯·åŠæ—¶å°±åŒ»æ£€æŸ¥ã€‚</div></div>
            </div>
        </div>
    </div>
    
    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="bottom-nav">
        <button class="nav-item active" onclick="showPage('page-home')" id="nav-home"><span class="nav-icon">ğŸ </span><span>é¦–é¡µ</span></button>
        <button class="nav-item" onclick="showPage('page-gi')" id="nav-gi"><span class="nav-icon">ğŸ”</span><span>GIæŸ¥è¯¢</span></button>
        <button class="nav-add" onclick="showModal('add-meal-modal')">+</button>
        <button class="nav-item" onclick="showPage('page-guide')" id="nav-guide"><span class="nav-icon">ğŸ“‹</span><span>æŒ‡å—</span></button>
        <button class="nav-item" onclick="showPage('page-stats')" id="nav-stats"><span class="nav-icon">ğŸ“Š</span><span>ç»Ÿè®¡</span></button>
    </div>
    
    <!-- æ·»åŠ è®°å½•æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="add-meal-modal">
        <div class="modal-content" style="max-height:90vh;overflow-y:auto;">
            <div class="modal-header" style="position:sticky;top:0;background:white;z-index:10;padding-bottom:16px;">
                <div class="modal-title">ğŸ“ æ·»åŠ æ¯æ—¥è®°å½•</div>
                <button class="modal-close" onclick="hideModal('add-meal-modal')">âœ•</button>
            </div>

            <!-- æ—¥æœŸé€‰æ‹© -->
            <div style="margin-bottom:18px;padding:12px;background:var(--primary-light);border-radius:10px;">
                <label style="font-size:0.85rem;color:var(--primary-dark);display:block;margin-bottom:6px;font-weight:600;">ğŸ“… é€‰æ‹©æ—¥æœŸ</label>
                <input type="date" id="record-date-input" style="width:100%;padding:12px;border:2px solid var(--primary);border-radius:10px;font-size:1rem;font-weight:600;">
            </div>

            <!-- æ¯æ—¥æ•°æ® -->
            <div style="background:var(--bg);border-radius:12px;padding:14px;margin-bottom:16px;">
                <h3 style="font-size:0.9rem;font-weight:700;margin-bottom:12px;color:var(--text);">ğŸ“Š æ¯æ—¥æ•°æ®</h3>
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:10px;">
                    <div>
                        <label style="font-size:0.8rem;color:var(--text-light);display:block;margin-bottom:4px;">âš–ï¸ ä½“é‡ (kg)</label>
                        <input type="number" step="0.1" id="weight-input" style="width:100%;padding:10px;border:2px solid var(--border);border-radius:8px;font-size:0.95rem;" placeholder="67.5">
                    </div>
                    <div>
                        <label style="font-size:0.8rem;color:var(--text-light);display:block;margin-bottom:4px;">ğŸ©¸ ç©ºè…¹è¡€ç³–</label>
                        <input type="number" id="fasting-input" style="width:100%;padding:10px;border:2px solid var(--border);border-radius:8px;font-size:0.95rem;" placeholder="mg/dL">
                    </div>
                </div>
                <div style="margin-bottom:10px;">
                    <label style="font-size:0.8rem;color:var(--text-light);display:block;margin-bottom:4px;">ğŸ‘£ æ­¥æ•°</label>
                    <input type="number" id="steps-input" style="width:100%;padding:10px;border:2px solid var(--border);border-radius:8px;font-size:0.95rem;" placeholder="6000">
                </div>
                <div>
                    <label style="font-size:0.8rem;color:var(--text-light);display:block;margin-bottom:4px;">ğŸ“ å¤‡æ³¨</label>
                    <textarea id="notes-input" style="width:100%;padding:10px;border:2px solid var(--border);border-radius:8px;font-size:0.9rem;font-family:inherit;resize:none;height:50px;" placeholder="èº«ä½“çŠ¶å†µã€ç‰¹æ®Šæƒ…å†µ..."></textarea>
                </div>
            </div>

            <!-- æ—©é¤ -->
            <div style="background:linear-gradient(135deg, #FFF4E6 0%, #FFE8CC 100%);border-radius:12px;padding:14px;margin-bottom:12px;">
                <h3 style="font-size:0.9rem;font-weight:700;margin-bottom:10px;color:#E67E00;">ğŸŒ… æ—©é¤</h3>
                <div style="margin-bottom:8px;">
                    <label style="font-size:0.8rem;color:#996600;display:block;margin-bottom:4px;">é£Ÿç‰©å†…å®¹</label>
                    <textarea id="breakfast-foods" oninput="updateCarbsHint('breakfast')" style="width:100%;padding:10px;border:2px solid #FFD9A3;border-radius:8px;font-size:0.9rem;font-family:inherit;resize:none;height:60px;" placeholder="ä¾‹å¦‚ï¼šç„ç±³é¥­ã€é¸¡è›‹ã€è¥¿å…°èŠ±ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰"></textarea>
                    <div id="breakfast-carbs-hint" style="font-size:0.75rem;color:#996600;margin-top:4px;padding:6px 10px;background:#FFF9F0;border-radius:6px;display:none;">
                        <span style="font-weight:600;">ğŸ’¡ ç¢³æ°´ä¼°ç®—ï¼š</span><span id="breakfast-carbs-value"></span>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                    <div>
                        <label style="font-size:0.8rem;color:#996600;display:block;margin-bottom:4px;">é¤åè¡€ç³–</label>
                        <input type="number" id="breakfast-glucose" style="width:100%;padding:10px;border:2px solid #FFD9A3;border-radius:8px;font-size:0.95rem;" placeholder="mg/dL">
                    </div>
                    <div>
                        <label style="font-size:0.8rem;color:#996600;display:block;margin-bottom:4px;">æµ‹é‡æ—¶é—´</label>
                        <input type="time" id="breakfast-time" style="width:100%;padding:10px;border:2px solid #FFD9A3;border-radius:8px;font-size:0.95rem;">
                    </div>
                </div>
            </div>

            <!-- åˆé¤ -->
            <div style="background:linear-gradient(135deg, #E8F8F5 0%, #D1F2EB 100%);border-radius:12px;padding:14px;margin-bottom:12px;">
                <h3 style="font-size:0.9rem;font-weight:700;margin-bottom:10px;color:#16A085;">â˜€ï¸ åˆé¤</h3>
                <div style="margin-bottom:8px;">
                    <label style="font-size:0.8rem;color:#0E6655;display:block;margin-bottom:4px;">é£Ÿç‰©å†…å®¹</label>
                    <textarea id="lunch-foods" oninput="updateCarbsHint('lunch')" style="width:100%;padding:10px;border:2px solid #A9DFBF;border-radius:8px;font-size:0.9rem;font-family:inherit;resize:none;height:60px;" placeholder="ä¾‹å¦‚ï¼šé¸¡èƒ¸è‚‰ã€é’èœã€æ‚ç²®é¥­ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰"></textarea>
                    <div id="lunch-carbs-hint" style="font-size:0.75rem;color:#0E6655;margin-top:4px;padding:6px 10px;background:#E8F8F5;border-radius:6px;display:none;">
                        <span style="font-weight:600;">ğŸ’¡ ç¢³æ°´ä¼°ç®—ï¼š</span><span id="lunch-carbs-value"></span>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                    <div>
                        <label style="font-size:0.8rem;color:#0E6655;display:block;margin-bottom:4px;">é¤åè¡€ç³–</label>
                        <input type="number" id="lunch-glucose" style="width:100%;padding:10px;border:2px solid #A9DFBF;border-radius:8px;font-size:0.95rem;" placeholder="mg/dL">
                    </div>
                    <div>
                        <label style="font-size:0.8rem;color:#0E6655;display:block;margin-bottom:4px;">æµ‹é‡æ—¶é—´</label>
                        <input type="time" id="lunch-time" style="width:100%;padding:10px;border:2px solid #A9DFBF;border-radius:8px;font-size:0.95rem;">
                    </div>
                </div>
            </div>

            <!-- æ™šé¤ -->
            <div style="background:linear-gradient(135deg, #EBF5FB 0%, #D6EAF8 100%);border-radius:12px;padding:14px;margin-bottom:20px;">
                <h3 style="font-size:0.9rem;font-weight:700;margin-bottom:10px;color:#2874A6;">ğŸŒ™ æ™šé¤</h3>
                <div style="margin-bottom:8px;">
                    <label style="font-size:0.8rem;color:#1B4F72;display:block;margin-bottom:4px;">é£Ÿç‰©å†…å®¹</label>
                    <textarea id="dinner-foods" oninput="updateCarbsHint('dinner')" style="width:100%;padding:10px;border:2px solid#AED6F1;border-radius:8px;font-size:0.9rem;font-family:inherit;resize:none;height:60px;" placeholder="ä¾‹å¦‚ï¼šé±¼ã€è±†è…ã€ç„ç±³ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰"></textarea>
                    <div id="dinner-carbs-hint" style="font-size:0.75rem;color:#1B4F72;margin-top:4px;padding:6px 10px;background:#EBF5FB;border-radius:6px;display:none;">
                        <span style="font-weight:600;">ğŸ’¡ ç¢³æ°´ä¼°ç®—ï¼š</span><span id="dinner-carbs-value"></span>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                    <div>
                        <label style="font-size:0.8rem;color:#1B4F72;display:block;margin-bottom:4px;">é¤åè¡€ç³–</label>
                        <input type="number" id="dinner-glucose" style="width:100%;padding:10px;border:2px solid #AED6F1;border-radius:8px;font-size:0.95rem;" placeholder="mg/dL">
                    </div>
                    <div>
                        <label style="font-size:0.8rem;color:#1B4F72;display:block;margin-bottom:4px;">æµ‹é‡æ—¶é—´</label>
                        <input type="time" id="dinner-time" style="width:100%;padding:10px;border:2px solid #AED6F1;border-radius:8px;font-size:0.95rem;">
                    </div>
                </div>
            </div>

            <button style="width:100%;padding:16px;background:var(--primary);color:white;border:none;border-radius:12px;font-size:1rem;font-weight:700;cursor:pointer;box-shadow:0 4px 12px rgba(255,107,157,0.3);" onclick="saveAllDayData()">ğŸ’¾ ä¿å­˜å½“å¤©æ‰€æœ‰è®°å½•</button>
            <div style="text-align:center;font-size:0.75rem;color:var(--text-light);margin-top:10px;">ğŸ’¡ å¡«å†™éƒ¨åˆ†æ•°æ®ä¹Ÿå¯ä»¥ä¿å­˜ï¼Œç©ºç™½é¡¹ä¼šè¢«è·³è¿‡</div>
        </div>
    </div>

    <script>
        // ==================== Google Drive äº‘ç«¯åŒæ­¥ ====================

        // Google API é…ç½®
        const GOOGLE_CONFIG = {
            // Google OAuth å®¢æˆ·ç«¯IDï¼ˆå·²é…ç½®ï¼‰
            CLIENT_ID: '537136117466-baeuop4v22idi62uhpf2hm2efd00jgnp.apps.googleusercontent.com',
            API_KEY: '',  // ä¸éœ€è¦API Keyï¼Œä½¿ç”¨OAuthå³å¯
            DISCOVERY_DOCS: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
            SCOPES: 'https://www.googleapis.com/auth/drive.file',
            FILE_NAME: 'tangma-diary-data.json',
            FILE_MIME_TYPE: 'application/json'
        };

        // Google Drive çŠ¶æ€
        let googleDriveState = {
            isConnected: false,
            accessToken: null,
            userEmail: null,
            fileId: null,
            lastSyncTime: null
        };

        // Google API åˆå§‹åŒ–çŠ¶æ€
        let googleApiReady = false;
        let googleApiInitPromise = null;

        // ä» localStorage æ¢å¤ Google Drive çŠ¶æ€
        function loadGoogleDriveState() {
            try {
                const saved = localStorage.getItem('google_drive_state');
                if (saved) {
                    const state = JSON.parse(saved);
                    googleDriveState = { ...googleDriveState, ...state };

                    // å¦‚æœæœ‰ä¿å­˜çš„tokenï¼Œå°è¯•æ¢å¤è¿æ¥çŠ¶æ€
                    if (state.accessToken && state.userEmail) {
                        updateGoogleDriveUI(true);
                    }
                }
            } catch (e) {
                console.error('åŠ è½½Google DriveçŠ¶æ€å¤±è´¥:', e);
            }
        }

        // ä¿å­˜ Google Drive çŠ¶æ€åˆ° localStorage
        function saveGoogleDriveState() {
            try {
                localStorage.setItem('google_drive_state', JSON.stringify(googleDriveState));
            } catch (e) {
                console.error('ä¿å­˜Google DriveçŠ¶æ€å¤±è´¥:', e);
            }
        }

        // åˆå§‹åŒ– Google API
        function initGoogleAPI() {
            // æ£€æŸ¥é…ç½®æ˜¯å¦å·²æ›´æ–°
            if (GOOGLE_CONFIG.CLIENT_ID === 'YOUR_CLIENT_ID.apps.googleusercontent.com') {
                console.warn('âš ï¸ Google Drive åŠŸèƒ½éœ€è¦é…ç½® OAuth å®¢æˆ·ç«¯ID');
                console.warn('è¯·è®¿é—®ï¼šhttps://console.cloud.google.com/apis/credentials');
                return Promise.reject('æœªé…ç½®å®¢æˆ·ç«¯ID');
            }

            // å¦‚æœæ­£åœ¨åˆå§‹åŒ–ï¼Œè¿”å›å·²æœ‰çš„Promise
            if (googleApiInitPromise) {
                return googleApiInitPromise;
            }

            // å¦‚æœå·²ç»åˆå§‹åŒ–å®Œæˆï¼Œç›´æ¥è¿”å›
            if (googleApiReady) {
                return Promise.resolve();
            }

            // åˆ›å»ºåˆå§‹åŒ–Promise
            googleApiInitPromise = new Promise((resolve, reject) => {
                // æ£€æŸ¥gapiæ˜¯å¦åŠ è½½
                if (typeof gapi === 'undefined') {
                    reject(new Error('Google API è„šæœ¬æœªåŠ è½½'));
                    return;
                }

                gapi.load('client:auth2', async () => {
                    try {
                        await gapi.client.init({
                            apiKey: GOOGLE_CONFIG.API_KEY,
                            clientId: GOOGLE_CONFIG.CLIENT_ID,
                            discoveryDocs: GOOGLE_CONFIG.DISCOVERY_DOCS,
                            scope: GOOGLE_CONFIG.SCOPES
                        });

                        googleApiReady = true;
                        console.log('âœ… Google API åˆå§‹åŒ–æˆåŠŸ');

                        // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
                        const isSignedIn = gapi.auth2.getAuthInstance().isSignedIn.get();
                        if (isSignedIn) {
                            handleGoogleSignIn();
                        }

                        resolve();
                    } catch (error) {
                        console.error('Google API åˆå§‹åŒ–å¤±è´¥:', error);
                        reject(error);
                    }
                });
            });

            return googleApiInitPromise;
        }

        // è¿æ¥ Google Drive
        async function connectGoogleDrive() {
            if (GOOGLE_CONFIG.CLIENT_ID === 'YOUR_CLIENT_ID.apps.googleusercontent.com') {
                alert('âš ï¸ Google Drive åŠŸèƒ½éœ€è¦é…ç½®\n\nè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è®¾ç½®ï¼š\n\n1. è®¿é—® Google Cloud Console\n2. åˆ›å»º OAuth 2.0 å®¢æˆ·ç«¯ID\n3. å°†å®¢æˆ·ç«¯IDå¡«å…¥ä»£ç é…ç½®\n\nè¯¦ç»†è¯´æ˜è¯·æŸ¥çœ‹ä»£ç æ³¨é‡Š');
                return;
            }

            try {
                // æ˜¾ç¤ºåŠ è½½æç¤º
                console.log('ğŸ”„ æ­£åœ¨åˆå§‹åŒ– Google API...');

                // ç­‰å¾… Google API åˆå§‹åŒ–å®Œæˆ
                await initGoogleAPI();

                // æ£€æŸ¥æ˜¯å¦å·²æœ‰è®¤è¯å®ä¾‹
                if (typeof gapi === 'undefined' || !gapi.auth2) {
                    throw new Error('Google API æœªæ­£ç¡®åŠ è½½');
                }

                const authInstance = gapi.auth2.getAuthInstance();
                if (!authInstance) {
                    throw new Error('æ— æ³•è·å–è®¤è¯å®ä¾‹');
                }

                console.log('ğŸ” æ­£åœ¨æ‰“å¼€ç™»å½•çª—å£...');
                await authInstance.signIn();

                handleGoogleSignIn();
            } catch (error) {
                console.error('Google ç™»å½•å¤±è´¥:', error);

                let errorMessage = 'ç™»å½•å¤±è´¥';
                if (error.error === 'popup_closed_by_user') {
                    errorMessage = 'æ‚¨å–æ¶ˆäº†ç™»å½•';
                } else if (error.error === 'access_denied') {
                    errorMessage = 'æ‚¨æ‹’ç»äº†æˆæƒ';
                } else if (error.message) {
                    errorMessage = error.message;
                }

                alert('âŒ ' + errorMessage + '\n\nå¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š\n1. ç¡®ä¿å…è®¸å¼¹å‡ºçª—å£\n2. æ£€æŸ¥ç½‘ç»œè¿æ¥\n3. åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        // å¤„ç† Google ç™»å½•æˆåŠŸ
        function handleGoogleSignIn() {
            const authInstance = gapi.auth2.getAuthInstance();
            const user = authInstance.currentUser.get();
            const profile = user.getBasicProfile();
            const authResponse = user.getAuthResponse(true);

            googleDriveState.isConnected = true;
            googleDriveState.accessToken = authResponse.access_token;
            googleDriveState.userEmail = profile.getEmail();

            saveGoogleDriveState();
            updateGoogleDriveUI(true);

            console.log('âœ… Google Drive è¿æ¥æˆåŠŸ:', googleDriveState.userEmail);

            // é¦–æ¬¡è¿æ¥æ—¶ï¼Œè‡ªåŠ¨ä¸Šä¼ å½“å‰æ•°æ®
            if (allData && allData.length > 0) {
                if (confirm('ğŸ‰ Google Drive è¿æ¥æˆåŠŸï¼\n\næ˜¯å¦ç«‹å³å¤‡ä»½å½“å‰æ•°æ®åˆ°äº‘ç«¯ï¼Ÿ')) {
                    manualSyncToDrive();
                }
            }
        }

        // æ–­å¼€ Google Drive è¿æ¥
        async function disconnectGoogleDrive() {
            if (!confirm('ç¡®è®¤æ–­å¼€ Google Drive è¿æ¥å—ï¼Ÿ\n\næ–­å¼€åä¸ä¼šåˆ é™¤äº‘ç«¯æ•°æ®ï¼Œä½†ä¸å†è‡ªåŠ¨åŒæ­¥ã€‚')) {
                return;
            }

            try {
                if (googleApiReady && typeof gapi !== 'undefined' && gapi.auth2) {
                    const authInstance = gapi.auth2.getAuthInstance();
                    if (authInstance) {
                        await authInstance.signOut();
                    }
                }

                googleDriveState = {
                    isConnected: false,
                    accessToken: null,
                    userEmail: null,
                    fileId: null,
                    lastSyncTime: null
                };

                saveGoogleDriveState();
                updateGoogleDriveUI(false);

                alert('âœ… å·²æ–­å¼€ Google Drive è¿æ¥');
            } catch (error) {
                console.error('æ–­å¼€è¿æ¥å¤±è´¥:', error);
                alert('âŒ æ–­å¼€è¿æ¥å¤±è´¥ï¼š' + error.message);
            }
        }

        // æ›´æ–° Google Drive UI
        function updateGoogleDriveUI(isConnected) {
            const notConnectedDiv = document.getElementById('google-drive-not-connected');
            const connectedDiv = document.getElementById('google-drive-connected');
            const statusBadge = document.getElementById('sync-status-badge');
            const userEmailSpan = document.getElementById('user-email');
            const lastSyncSpan = document.getElementById('last-sync-time');

            if (isConnected) {
                notConnectedDiv.style.display = 'none';
                connectedDiv.style.display = 'block';
                statusBadge.style.display = 'block';

                if (userEmailSpan) userEmailSpan.textContent = googleDriveState.userEmail || '';
                if (lastSyncSpan) {
                    if (googleDriveState.lastSyncTime) {
                        const date = new Date(googleDriveState.lastSyncTime);
                        lastSyncSpan.textContent = date.toLocaleString('zh-CN');
                    } else {
                        lastSyncSpan.textContent = 'ä»æœª';
                    }
                }
            } else {
                notConnectedDiv.style.display = 'block';
                connectedDiv.style.display = 'none';
                statusBadge.style.display = 'none';
            }
        }

        // ä¸Šä¼ æ•°æ®åˆ° Google Drive
        async function uploadToGoogleDrive(data) {
            if (!googleDriveState.isConnected) {
                throw new Error('æœªè¿æ¥åˆ° Google Drive');
            }

            const fileContent = JSON.stringify(data, null, 2);
            const boundary = '-------314159265358979323846';
            const delimiter = "\r\n--" + boundary + "\r\n";
            const close_delim = "\r\n--" + boundary + "--";

            const metadata = {
                name: GOOGLE_CONFIG.FILE_NAME,
                mimeType: GOOGLE_CONFIG.FILE_MIME_TYPE
            };

            const multipartRequestBody =
                delimiter +
                'Content-Type: application/json\r\n\r\n' +
                JSON.stringify(metadata) +
                delimiter +
                'Content-Type: ' + GOOGLE_CONFIG.FILE_MIME_TYPE + '\r\n\r\n' +
                fileContent +
                close_delim;

            const method = googleDriveState.fileId ? 'PATCH' : 'POST';
            const url = googleDriveState.fileId
                ? `https://www.googleapis.com/upload/drive/v3/files/${googleDriveState.fileId}?uploadType=multipart`
                : 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Authorization': 'Bearer ' + googleDriveState.accessToken,
                    'Content-Type': 'multipart/related; boundary=' + boundary
                },
                body: multipartRequestBody
            });

            if (!response.ok) {
                throw new Error('ä¸Šä¼ å¤±è´¥: ' + response.statusText);
            }

            const result = await response.json();
            googleDriveState.fileId = result.id;
            googleDriveState.lastSyncTime = new Date().toISOString();
            saveGoogleDriveState();
            updateGoogleDriveUI(true);

            return result;
        }

        // ä» Google Drive ä¸‹è½½æ•°æ®
        async function downloadFromGoogleDrive() {
            if (!googleDriveState.isConnected) {
                throw new Error('æœªè¿æ¥åˆ° Google Drive');
            }

            // å…ˆæŸ¥æ‰¾æ–‡ä»¶
            if (!googleDriveState.fileId) {
                const searchResponse = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q=name='${GOOGLE_CONFIG.FILE_NAME}'&spaces=drive`,
                    {
                        headers: {
                            'Authorization': 'Bearer ' + googleDriveState.accessToken
                        }
                    }
                );

                const searchResult = await searchResponse.json();
                if (searchResult.files && searchResult.files.length > 0) {
                    googleDriveState.fileId = searchResult.files[0].id;
                    saveGoogleDriveState();
                } else {
                    return null; // æ–‡ä»¶ä¸å­˜åœ¨
                }
            }

            // ä¸‹è½½æ–‡ä»¶å†…å®¹
            const response = await fetch(
                `https://www.googleapis.com/drive/v3/files/${googleDriveState.fileId}?alt=media`,
                {
                    headers: {
                        'Authorization': 'Bearer ' + googleDriveState.accessToken
                    }
                }
            );

            if (!response.ok) {
                throw new Error('ä¸‹è½½å¤±è´¥: ' + response.statusText);
            }

            const data = await response.json();
            return data;
        }

        // æ‰‹åŠ¨å¤‡ä»½åˆ°äº‘ç«¯
        async function manualSyncToDrive() {
            if (!googleDriveState.isConnected) {
                alert('âŒ è¯·å…ˆè¿æ¥ Google Drive');
                return;
            }

            try {
                const dataToUpload = {
                    version: STORAGE_VERSION,
                    data: allData,
                    lastUpdate: new Date().toISOString()
                };

                await uploadToGoogleDrive(dataToUpload);
                alert('âœ… æ•°æ®å·²æˆåŠŸå¤‡ä»½åˆ° Google Driveï¼');
                console.log('âœ… å¤‡ä»½æˆåŠŸ');
            } catch (error) {
                console.error('å¤‡ä»½å¤±è´¥:', error);
                alert('âŒ å¤‡ä»½å¤±è´¥ï¼š' + error.message);
            }
        }

        // æ‰‹åŠ¨ä»äº‘ç«¯æ¢å¤
        async function manualSyncFromDrive() {
            if (!googleDriveState.isConnected) {
                alert('âŒ è¯·å…ˆè¿æ¥ Google Drive');
                return;
            }

            if (!confirm('âš ï¸ ç¡®è®¤ä»äº‘ç«¯æ¢å¤æ•°æ®å—ï¼Ÿ\n\nè¿™å°†è¦†ç›–å½“å‰æ‰€æœ‰æœ¬åœ°æ•°æ®ï¼\nå»ºè®®å…ˆå¯¼å‡ºæœ¬åœ°æ•°æ®å¤‡ä»½ã€‚')) {
                return;
            }

            try {
                const cloudData = await downloadFromGoogleDrive();

                if (!cloudData) {
                    alert('â„¹ï¸ äº‘ç«¯æš‚æ— å¤‡ä»½æ•°æ®');
                    return;
                }

                if (cloudData.data && Array.isArray(cloudData.data)) {
                    allData = cloudData.data;
                    saveData();
                    location.reload();
                } else {
                    alert('âŒ äº‘ç«¯æ•°æ®æ ¼å¼é”™è¯¯');
                }
            } catch (error) {
                console.error('æ¢å¤å¤±è´¥:', error);
                alert('âŒ æ¢å¤å¤±è´¥ï¼š' + error.message);
            }
        }

        // è‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯ï¼ˆä¿å­˜æ•°æ®æ—¶è°ƒç”¨ï¼‰
        async function autoSyncToDrive() {
            if (!googleDriveState.isConnected) {
                return; // æœªè¿æ¥åˆ™ä¸è‡ªåŠ¨åŒæ­¥
            }

            try {
                const dataToUpload = {
                    version: STORAGE_VERSION,
                    data: allData,
                    lastUpdate: new Date().toISOString()
                };

                await uploadToGoogleDrive(dataToUpload);
                console.log('âœ… è‡ªåŠ¨å¤‡ä»½åˆ° Google Drive æˆåŠŸ');
            } catch (error) {
                console.warn('âš ï¸ è‡ªåŠ¨å¤‡ä»½å¤±è´¥:', error);
                // ä¸æ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œé¿å…æ‰“æ‰°ç”¨æˆ·
            }
        }

        // å¯åŠ¨æ—¶è‡ªåŠ¨ä»äº‘ç«¯æ¢å¤ï¼ˆå¦‚æœäº‘ç«¯æ›´æ–°ï¼‰
        async function autoRestoreFromDrive() {
            if (!googleDriveState.isConnected || !googleApiReady) {
                return;
            }

            try {
                const cloudData = await downloadFromGoogleDrive();

                if (!cloudData || !cloudData.data) {
                    return;
                }

                // æ¯”è¾ƒæ—¶é—´æˆ³ï¼Œå¦‚æœäº‘ç«¯æ›´æ–°åˆ™æç¤ºæ¢å¤
                const localUpdate = localStorage.getItem('tangma_diary_data');
                if (localUpdate) {
                    const localData = JSON.parse(localUpdate);
                    const localTime = new Date(localData.lastUpdate || 0);
                    const cloudTime = new Date(cloudData.lastUpdate || 0);

                    if (cloudTime > localTime) {
                        if (confirm('â˜ï¸ æ£€æµ‹åˆ°äº‘ç«¯æœ‰æ›´æ–°çš„æ•°æ®\n\næ˜¯å¦æ¢å¤äº‘ç«¯æ•°æ®ï¼Ÿ\n\näº‘ç«¯æ›´æ–°æ—¶é—´ï¼š' + cloudTime.toLocaleString('zh-CN') + '\næœ¬åœ°æ›´æ–°æ—¶é—´ï¼š' + localTime.toLocaleString('zh-CN'))) {
                            allData = cloudData.data;
                            saveData();
                            location.reload();
                        }
                    }
                }
            } catch (error) {
                console.warn('âš ï¸ è‡ªåŠ¨æ¢å¤æ£€æŸ¥å¤±è´¥:', error);
            }
        }

        // localStorage ç®¡ç†
        const STORAGE_KEY = 'tangma_diary_data';
        const STORAGE_VERSION = '1.0';

        // ä¿å­˜æ•°æ®åˆ° localStorage
        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify({
                    version: STORAGE_VERSION,
                    data: allData,
                    lastUpdate: new Date().toISOString()
                }));
                console.log('âœ… æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°');

                // è‡ªåŠ¨åŒæ­¥åˆ°Google Driveï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ä¿å­˜ï¼‰
                autoSyncToDrive().catch(err => {
                    console.warn('è‡ªåŠ¨åŒæ­¥å¤±è´¥:', err);
                });
            } catch (e) {
                console.error('âŒ ä¿å­˜å¤±è´¥:', e);
                alert('æ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®');
            }
        }

        // ä» localStorage åŠ è½½æ•°æ®
        function loadData() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    const parsed = JSON.parse(stored);
                    console.log('âœ… åŠ è½½å·²ä¿å­˜æ•°æ®ï¼Œæœ€åæ›´æ–°:', parsed.lastUpdate);
                    return parsed.data;
                }
            } catch (e) {
                console.error('âŒ åŠ è½½å¤±è´¥:', e);
            }
            console.log('ğŸ“ ä½¿ç”¨ç¤ºä¾‹æ•°æ®');
            return null;
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const dataStr = JSON.stringify({
                version: STORAGE_VERSION,
                exportDate: new Date().toISOString(),
                data: allData
            }, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ç³–å¦ˆæ—¥è®°_${new Date().toISOString().slice(0,10)}.json`;
            link.click();
            URL.revokeObjectURL(url);
            alert('âœ… æ•°æ®å¯¼å‡ºæˆåŠŸï¼');
        }

        // å¯¼å…¥æ•°æ®
        function importData(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (imported.data && Array.isArray(imported.data)) {
                        if (confirm('ç¡®è®¤å¯¼å…¥æ•°æ®ï¼Ÿè¿™å°†è¦†ç›–å½“å‰æ‰€æœ‰è®°å½•ã€‚')) {
                            allData = imported.data;
                            saveData();
                            location.reload();
                        }
                    } else {
                        alert('âŒ æ•°æ®æ ¼å¼é”™è¯¯');
                    }
                } catch (err) {
                    alert('âŒ å¯¼å…¥å¤±è´¥: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        // æ¸…é™¤æ‰€æœ‰æ•°æ®ï¼ˆç”¨äºé‡ç½®ï¼‰
        function clearAllData() {
            if (confirm('âš ï¸ ç¡®è®¤æ¸…é™¤æ‰€æœ‰æ•°æ®ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼\n\nå»ºè®®å…ˆå¯¼å‡ºå¤‡ä»½ã€‚')) {
                if (confirm('ğŸ”´ å†æ¬¡ç¡®è®¤ï¼šçœŸçš„è¦åˆ é™¤æ‰€æœ‰è®°å½•å—ï¼Ÿ')) {
                    localStorage.removeItem(STORAGE_KEY);
                    location.reload();
                }
            }
        }

        // æ¢å¤ç¤ºä¾‹æ•°æ®ï¼ˆç”¨äºæµ‹è¯•æˆ–å­¦ä¹ ä½¿ç”¨ï¼‰
        function loadSampleData() {
            if (confirm('ğŸ”„ åŠ è½½ç¤ºä¾‹æ•°æ®å—ï¼Ÿ\n\nè¿™å°†è¦†ç›–å½“å‰æ‰€æœ‰è®°å½•ã€‚\nå»ºè®®å…ˆå¯¼å‡ºå¤‡ä»½ï¼\n\nç¤ºä¾‹æ•°æ®åŒ…å«è¿‘ä¸¤å‘¨çš„å®Œæ•´é¥®é£Ÿå’Œè¡€ç³–è®°å½•ï¼Œå¸®åŠ©æ‚¨äº†è§£å¦‚ä½•ä½¿ç”¨æœ¬åº”ç”¨ã€‚')) {
                // åŠ è½½defaultDataä½œä¸ºç¤ºä¾‹
                allData = JSON.parse(JSON.stringify(defaultData)); // æ·±æ‹·è´
                saveData();
                location.reload();
            }
        }

        // é»˜è®¤ç¤ºä¾‹æ•°æ®
        const defaultData = [
            { date: "12æœˆ5æ—¥", weekday: "å‘¨å››", weight: 68.3, fasting: 94, steps: null,
              meals: [{ type: "dinner", time: "17:54", foods: ["æ‚ç²®é¥­", "èŒ„å­é’æ¤’çŒªè‚‰", "é±¼", "å‘³å¢è±†è…"], glucose: 115 }] },
            { date: "12æœˆ6æ—¥", weekday: "å‘¨äº”", weight: 67.6, fasting: 88, steps: 6754,
              meals: [
                { type: "breakfast", time: "9:07", foods: ["é¢åŒ…", "è¥¿çº¢æŸ¿", "é¸¡è›‹", "é»‘è±†èŒ¶"], glucose: 110 },
                { type: "lunch", time: "12:20", foods: ["èŠ±è›¤æ±¤", "è±†è…", "é¸¡è‚‰", "è”¬èœ", "çº³è±†"], glucose: 141 },
                { type: "dinner", time: "18:24", foods: ["éº»è¾£çƒ«"], glucose: 96 }
              ] },
            { date: "12æœˆ7æ—¥", weekday: "å‘¨å…­", weight: 68.1, fasting: 85, steps: 6805, notes: "é»‘ä¾¿",
              meals: [
                { type: "breakfast", time: "10:24", foods: ["é¥ºå­", "ç´«èœæ±¤", "é»„ç“œ", "é¥¼å¹²"], glucose: 127 },
                { type: "lunch", time: "13:19", foods: ["é‡‘é’ˆè‡", "ç‰›è‚‰æ´‹è‘±", "é’èœ"], glucose: 127 },
                { type: "dinner", time: "18:48", foods: ["æµ·å¸¦ä¸", "æ¯›è±†", "æ’éª¨", "ç±³ç²‰"], glucose: 110 }
              ] },
            { date: "12æœˆ8æ—¥", weekday: "å‘¨æ—¥", weight: 67.8, fasting: 90, steps: 6789,
              meals: [
                { type: "breakfast", time: "9:04", foods: ["é¥ºå­", "æ©™å­", "ç•ªèŒ„"], glucose: 120 },
                { type: "lunch", time: "12:40", foods: ["ç‰›è‚‰", "é’èœ", "ç„ç±³"], glucose: 111 },
                { type: "dinner", time: "18:50", foods: ["é¸¡è‚‰", "é’èœ", "ç´«èœè±†è…æ±¤", "ç„ç±³"], glucose: 94 }
              ] },
            { date: "12æœˆ9æ—¥", weekday: "å‘¨ä¸€", weight: 68.1, fasting: 89, steps: 8051, notes: "é»‘ä¾¿",
              meals: [
                { type: "breakfast", time: "9:05", foods: ["é¥ºå­", "æ©˜å­"], glucose: 109 },
                { type: "lunch", time: "12:52", foods: ["é¸¡æ’", "è¥¿çº¢æŸ¿ç‚’è›‹", "è˜‘è‡æ±¤"], glucose: 116 },
                { type: "dinner", time: "17:55", foods: ["é¸¡å—", "èŠ±æ¤°èœå’–å–±", "ç„ç±³"], glucose: 114 }
              ] },
            { date: "12æœˆ10æ—¥", weekday: "å‘¨äºŒ", weight: 67.9, fasting: null, steps: 6795,
              meals: [{ type: "dinner", time: "18:58", foods: ["é»„ç“œ", "è±†è…", "é¸¡è‚‰ä¸¸å­æ±¤", "å¥‡å¼‚æœ"], glucose: 105 }] },
            { date: "12æœˆ11æ—¥", weekday: "å‘¨ä¸‰", weight: 67.9, fasting: null, steps: 5451, notes: "æ²¡è¿åŠ¨",
              meals: [
                { type: "breakfast", time: "11:33", foods: ["é¥ºå­", "æ©˜å­"], glucose: 134 },
                { type: "dinner", time: "18:21", foods: ["çº³è±†", "ç„ç±³", "è”¬èœç‰›è‚‰æ±¤", "é¸¡è‚‰"], glucose: 117 }
              ] },
            { date: "12æœˆ12æ—¥", weekday: "å‘¨å››", weight: 67.5, fasting: null, steps: 3254, notes: "æ²¡è¿åŠ¨",
              meals: [
                { type: "breakfast", time: "9:36", foods: ["é¢åŒ…", "é¸¡è›‹", "å¥‡å¼‚æœ", "é¥ºå­"], glucose: 127 },
                { type: "lunch", time: "12:54", foods: ["æ‹Œé¢", "èŒ„å­é’æ¤’"], glucose: 99 },
                { type: "dinner", time: "19:37", foods: ["è›‹åŒ…é¥­"], glucose: 114 }
              ] },
            { date: "12æœˆ13æ—¥", weekday: "å‘¨äº”", weight: null, fasting: null, steps: 4750,
              meals: [
                { type: "breakfast", time: "10:03", foods: ["(æœªè®°å½•)"], glucose: 135 },
                { type: "lunch", time: "13:15", foods: ["(æœªè®°å½•)"], glucose: 102 },
                { type: "dinner", time: "18:13", foods: ["(æœªè®°å½•)"], glucose: 120 }
              ] },
            { date: "12æœˆ14æ—¥", weekday: "å‘¨å…­", weight: 67.5, fasting: 120, steps: 7367,
              meals: [{ type: "lunch", time: "11:52", foods: ["(æœªè®°å½•)"], glucose: 131 }] },
            { date: "12æœˆ15æ—¥", weekday: "å‘¨æ—¥", weight: null, fasting: null, steps: 6721,
              meals: [
                { type: "breakfast", time: "8:50", foods: ["é¦’å¤´", "è‚‰æ¾", "ç‰›å¥¶"], glucose: 134 },
                { type: "lunch", time: "12:30", foods: ["é±¼", "ç±³é¥­", "è”¬èœæ±¤", "é¥¼å¹²"], glucose: 140 },
                { type: "dinner", time: "18:57", foods: ["çº³è±†", "èŠ±è›¤", "é¸¡è‚‰", "ç±³é¥­"], glucose: 111 }
              ] },
            { date: "12æœˆ16æ—¥", weekday: "å‘¨ä¸€", weight: 67.0, fasting: null, steps: null,
              meals: [
                { type: "breakfast", time: "10:03", foods: ["é¢åŒ…", "è±†è…", "èŒ¶ç¢—è’¸", "ç‰›å¥¶"], glucose: 134 },
                { type: "lunch", time: "14:32", foods: ["é¸¡æ’", "ç±³é¥­", "ç´«èœè›‹æ±¤"], glucose: 128 },
                { type: "dinner", time: "18:45", foods: ["é¸¡æ’", "ç™½èœ"], glucose: 113 }
              ] },
            { date: "12æœˆ17æ—¥", weekday: "å‘¨äºŒ", weight: 67.7, fasting: null, steps: 5144,
              meals: [{ type: "breakfast", time: "8:36", foods: ["è±†æµ†", "è’¸è›‹", "é¢åŒ…", "è¥¿çº¢æŸ¿"], glucose: null }] }
        ];

        // å¤šè¯­è¨€æ”¯æŒ
        let currentLang = localStorage.getItem('app_language') || 'zh';

        // é€šçŸ¥æé†’è®¾ç½®
        let notificationEnabled = localStorage.getItem('notification_enabled') === 'true';
        let notificationTimers = []; // å­˜å‚¨æ‰€æœ‰å®šæ—¶å™¨ID

        // è¯·æ±‚é€šçŸ¥æƒé™
        function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.log('æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥åŠŸèƒ½');
                return false;
            }

            if (Notification.permission === 'granted') {
                notificationEnabled = true;
                localStorage.setItem('notification_enabled', 'true');
                return true;
            } else if (Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        notificationEnabled = true;
                        localStorage.setItem('notification_enabled', 'true');
                        showNotification('âœ… æé†’å·²å¼€å¯', 'æˆ‘ä»¬ä¼šåœ¨é¤å1-2å°æ—¶æé†’æ‚¨æµ‹è¡€ç³–');
                    }
                });
            }
            return false;
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(title, body, icon = 'ğŸ©¸') {
            if (!notificationEnabled || Notification.permission !== 'granted') {
                return;
            }

            const notification = new Notification(title, {
                body: body,
                icon: 'https://kkailab.github.io/tangma-diary/favicon.ico',
                badge: icon,
                tag: 'gdm-reminder',
                requireInteraction: false,
                silent: false
            });

            notification.onclick = function() {
                window.focus();
                notification.close();
            };
        }

        // è®¾ç½®é¤åè¡€ç³–æµ‹é‡æé†’
        function scheduleGlucoseReminder(mealType, mealTime, selectedDate) {
            if (!notificationEnabled || Notification.permission !== 'granted') {
                return;
            }

            // é¤æ¬¡åç§°æ˜ å°„
            const mealNames = {
                breakfast: { zh: 'æ—©é¤', ja: 'æœé£Ÿ', en: 'Breakfast' },
                lunch: { zh: 'åˆé¤', ja: 'æ˜¼é£Ÿ', en: 'Lunch' },
                dinner: { zh: 'æ™šé¤', ja: 'å¤•é£Ÿ', en: 'Dinner' }
            };

            const mealName = mealNames[mealType][currentLang] || mealNames[mealType].zh;

            // è§£æé¤æ—¶æ—¶é—´
            const [hours, minutes] = mealTime.split(':').map(Number);
            const mealDateTime = new Date(selectedDate);
            mealDateTime.setHours(hours, minutes, 0, 0);

            const now = new Date();

            // åªä¸ºä»Šå¤©æˆ–æœªæ¥çš„é¤æ¬¡è®¾ç½®æé†’
            if (mealDateTime <= now) {
                console.log(`â° ${mealName}æ—¶é—´å·²è¿‡ï¼Œä¸è®¾ç½®æé†’`);
                return;
            }

            // é¤å1å°æ—¶æé†’
            const reminder1h = new Date(mealDateTime.getTime() + 60 * 60 * 1000);
            const delay1h = reminder1h - now;

            if (delay1h > 0 && delay1h < 24 * 60 * 60 * 1000) { // 24å°æ—¶å†…
                const timer1h = setTimeout(() => {
                    const messages = {
                        zh: `${mealName}å1å°æ—¶äº†ï¼Œè¯¥æµ‹è¡€ç³–äº†ï¼\nç›®æ ‡ï¼š<140 mg/dL`,
                        ja: `${mealName}å¾Œ1æ™‚é–“ã§ã™ã€‚è¡€ç³–å€¤ã‚’æ¸¬å®šã—ã¦ãã ã•ã„ï¼\nç›®æ¨™ï¼š<140 mg/dL`,
                        en: `1 hour after ${mealName}. Time to check glucose!\nTarget: <140 mg/dL`
                    };
                    showNotification(
                        'ğŸ©¸ ' + (currentLang === 'zh' ? 'è¡€ç³–æµ‹é‡æé†’' : currentLang === 'ja' ? 'è¡€ç³–å€¤æ¸¬å®šãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼' : 'Glucose Check Reminder'),
                        messages[currentLang] || messages.zh
                    );
                }, delay1h);
                notificationTimers.push(timer1h);
                console.log(`â° å·²è®¾ç½®${mealName}é¤å1å°æ—¶æé†’: ${reminder1h.toLocaleTimeString()}`);
            }

            // é¤å2å°æ—¶æé†’
            const reminder2h = new Date(mealDateTime.getTime() + 120 * 60 * 1000);
            const delay2h = reminder2h - now;

            if (delay2h > 0 && delay2h < 24 * 60 * 60 * 1000) {
                const timer2h = setTimeout(() => {
                    const messages = {
                        zh: `${mealName}å2å°æ—¶äº†ï¼Œè®°å¾—æµ‹è¡€ç³–ï¼\nç›®æ ‡ï¼š<120 mg/dL`,
                        ja: `${mealName}å¾Œ2æ™‚é–“ã§ã™ã€‚è¡€ç³–å€¤ã‚’æ¸¬å®šã—ã¦ãã ã•ã„ï¼\nç›®æ¨™ï¼š<120 mg/dL`,
                        en: `2 hours after ${mealName}. Remember to check glucose!\nTarget: <120 mg/dL`
                    };
                    showNotification(
                        'ğŸ©¸ ' + (currentLang === 'zh' ? 'è¡€ç³–æµ‹é‡æé†’' : currentLang === 'ja' ? 'è¡€ç³–å€¤æ¸¬å®šãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼' : 'Glucose Check Reminder'),
                        messages[currentLang] || messages.zh
                    );
                }, delay2h);
                notificationTimers.push(timer2h);
                console.log(`â° å·²è®¾ç½®${mealName}é¤å2å°æ—¶æé†’: ${reminder2h.toLocaleTimeString()}`);
            }
        }

        // æ¸…é™¤æ‰€æœ‰æé†’
        function clearAllReminders() {
            notificationTimers.forEach(timer => clearTimeout(timer));
            notificationTimers = [];
            console.log('â° å·²æ¸…é™¤æ‰€æœ‰æé†’');
        }

        // ç¼–è¾‘é¤æ¬¡è®°å½•
        function editMealRecord(dateIndex, mealType) {
            const day = allData[dateIndex];
            const meal = day.meals.find(m => m.type === mealType);

            if (!meal) {
                alert('âŒ æœªæ‰¾åˆ°è¯¥è®°å½•');
                return;
            }

            // æ‰“å¼€æ·»åŠ è®°å½•æ¨¡æ€æ¡†
            showModal('add-meal-modal');

            // å¡«å……æ—¥æœŸ
            const dateInput = document.getElementById('record-date-input');
            if (dateInput && day.year) {
                const [month, dayNum] = day.date.replace('æœˆ', '-').replace('æ—¥', '').split('-');
                const dateStr = `${day.year}-${month.padStart(2, '0')}-${dayNum.padStart(2, '0')}`;
                dateInput.value = dateStr;
            }

            // å¡«å……å¯¹åº”é¤æ¬¡çš„æ•°æ®
            const foodsInput = document.getElementById(`${mealType}-foods`);
            const glucoseInput = document.getElementById(`${mealType}-glucose`);
            const timeInput = document.getElementById(`${mealType}-time`);

            if (foodsInput) foodsInput.value = meal.foods.join('ã€');
            if (glucoseInput && meal.glucose) glucoseInput.value = meal.glucose;
            if (timeInput && meal.time) timeInput.value = meal.time;

            // è§¦å‘ç¢³æ°´æç¤ºæ›´æ–°
            updateCarbsHint(mealType);

            // æç¤ºç”¨æˆ·
            setTimeout(() => {
                alert('ğŸ’¡ æç¤ºï¼š\n\nå·²åŠ è½½è¯¥é¤æ¬¡çš„æ•°æ®åˆ°è¡¨å•ä¸­ï¼Œæ‚¨å¯ä»¥ä¿®æ”¹åç‚¹å‡»"ä¿å­˜"æ›´æ–°è®°å½•ã€‚\n\næ³¨æ„ï¼šä¿å­˜åä¼šè¦†ç›–åŸè®°å½•ã€‚');
            }, 300);
        }

        // åˆ é™¤é¤æ¬¡è®°å½•
        function deleteMealRecord(dateIndex, mealType) {
            const day = allData[dateIndex];
            const meal = day.meals.find(m => m.type === mealType);

            if (!meal) {
                alert('âŒ æœªæ‰¾åˆ°è¯¥è®°å½•');
                return;
            }

            const mealNames = {
                breakfast: 'æ—©é¤',
                lunch: 'åˆé¤',
                dinner: 'æ™šé¤'
            };

            const confirmDelete = confirm(
                `ğŸ—‘ï¸ ç¡®è®¤åˆ é™¤å—ï¼Ÿ\n\næ—¥æœŸï¼š${day.date}\né¤æ¬¡ï¼š${mealNames[mealType]}\né£Ÿç‰©ï¼š${meal.foods.join('ã€')}\nè¡€ç³–ï¼š${meal.glucose || 'æœªæµ‹é‡'} mg/dL\n\nåˆ é™¤åæ— æ³•æ¢å¤ï¼`
            );

            if (!confirmDelete) return;

            // ä»mealsæ•°ç»„ä¸­åˆ é™¤è¯¥é¤æ¬¡
            const mealIndex = day.meals.findIndex(m => m.type === mealType);
            if (mealIndex >= 0) {
                day.meals.splice(mealIndex, 1);
            }

            // ä¿å­˜æ•°æ®
            saveData();

            // åˆ·æ–°æ˜¾ç¤º
            renderDayData(dateIndex);
            renderWeekTable();

            const chartElement = document.getElementById('glucose-chart');
            if (chartElement && chartElement.chart) {
                chartElement.chart.destroy();
            }
            initChart();

            // æ›´æ–°é£Ÿç‰©æ´å¯Ÿ
            renderFoodInsights();

            alert('âœ… å·²åˆ é™¤è¯¥è®°å½•');
        }

        // åˆ‡æ¢é€šçŸ¥å¼€å…³
        function toggleNotification() {
            if (!('Notification' in window)) {
                alert('âŒ æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥åŠŸèƒ½');
                return;
            }

            if (Notification.permission === 'denied') {
                alert('âŒ é€šçŸ¥æƒé™å·²è¢«æ‹’ç»\n\nè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸æœ¬ç½‘ç«™æ˜¾ç¤ºé€šçŸ¥ã€‚');
                return;
            }

            if (notificationEnabled) {
                // å…³é—­æé†’
                notificationEnabled = false;
                localStorage.setItem('notification_enabled', 'false');
                clearAllReminders();
                updateNotificationButton();
                alert('âœ… å·²å…³é—­é¤åæé†’');
            } else {
                // å¼€å¯æé†’
                if (Notification.permission === 'granted') {
                    notificationEnabled = true;
                    localStorage.setItem('notification_enabled', 'true');
                    updateNotificationButton();
                    showNotification('âœ… æé†’å·²å¼€å¯', 'æˆ‘ä»¬ä¼šåœ¨é¤å1-2å°æ—¶æé†’æ‚¨æµ‹è¡€ç³–');
                } else {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            notificationEnabled = true;
                            localStorage.setItem('notification_enabled', 'true');
                            updateNotificationButton();
                            showNotification('âœ… æé†’å·²å¼€å¯', 'æˆ‘ä»¬ä¼šåœ¨é¤å1-2å°æ—¶æé†’æ‚¨æµ‹è¡€ç³–');
                        } else {
                            alert('âŒ éœ€è¦é€šçŸ¥æƒé™æ‰èƒ½ä½¿ç”¨æé†’åŠŸèƒ½');
                        }
                    });
                }
            }
        }

        // æ›´æ–°é€šçŸ¥æŒ‰é’®çŠ¶æ€
        function updateNotificationButton() {
            const btn = document.getElementById('enable-notification-btn');
            const btnText = document.getElementById('notification-btn-text');
            if (!btn || !btnText) return;

            if (notificationEnabled && Notification.permission === 'granted') {
                btn.style.background = 'var(--success)';
                btnText.textContent = 'âœ“ æé†’å·²å¼€å¯';
            } else {
                btn.style.background = 'var(--primary)';
                btnText.textContent = 'å¼€å¯é¤åæé†’';
            }
        }

        // ç¿»è¯‘å‡½æ•°
        function t(key) {
            if (!translations || !translations[currentLang]) return key;
            const keys = key.split('.');
            let value = translations[currentLang];
            for (const k of keys) {
                if (value && typeof value === 'object') {
                    value = value[k];
                } else {
                    return key;
                }
            }
            return value || key;
        }

        // åˆ‡æ¢è¯­è¨€
        function switchLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('app_language', lang);

            // æ›´æ–°è¯­è¨€æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === lang);
            });

            // æ›´æ–°æ–‡æ¡£è¯­è¨€å±æ€§
            document.documentElement.lang = lang === 'zh' ? 'zh-CN' : (lang === 'ja' ? 'ja-JP' : 'en');

            // æ›´æ–°å­—ä½“
            if (lang === 'ja') {
                document.body.style.fontFamily = "'Noto Sans JP', -apple-system, sans-serif";
            } else if (lang === 'zh') {
                document.body.style.fontFamily = "'Noto Sans SC', -apple-system, sans-serif";
            } else {
                document.body.style.fontFamily = "-apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif";
            }

            // æ›´æ–°æ‰€æœ‰æ–‡æœ¬
            updateUILanguage();
        }

        // æ›´æ–°UIè¯­è¨€
        function updateUILanguage() {
            // æ›´æ–°æ ‡é¢˜
            document.title = t('appTitle') + ' - ' + t('appSubtitle');
            document.getElementById('app-title').textContent = t('appTitle');

            // é‡æ–°æ¸²æŸ“é¡µé¢
            if (currentDateIndex >= 0) {
                renderDateSelector();
                renderDayData(currentDateIndex);
            }
        }

        // åˆå§‹åŒ–æ•°æ®ï¼šä¼˜å…ˆä½¿ç”¨ localStorageï¼Œå¦åˆ™ç”¨ç¤ºä¾‹æ•°æ®
        // æ–°ç”¨æˆ·ä»ç©ºç™½å¼€å§‹ï¼Œå¯é€šè¿‡"æ¢å¤ç¤ºä¾‹æ•°æ®"æŒ‰é’®åŠ è½½ç¤ºä¾‹
        let allData = loadData() || [];
        
        // é£Ÿç‰©æ ‡ç­¾æ•°æ®åº“ï¼ˆä»USDA + Open Food Factsæ„å»ºï¼‰
        let foodTagsDatabase = null;

        // åŠ è½½é£Ÿç‰©æ ‡ç­¾æ•°æ®åº“
        async function loadFoodTagsDatabase() {
            try {
                const response = await fetch('food-tags-database.json');
                foodTagsDatabase = await response.json();
                console.log('âœ… é£Ÿç‰©æ ‡ç­¾æ•°æ®åº“åŠ è½½æˆåŠŸï¼Œå…±', foodTagsDatabase.totalFoods, 'ç§é£Ÿç‰©');
            } catch (error) {
                console.warn('âš ï¸ é£Ÿç‰©æ ‡ç­¾æ•°æ®åº“åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€æ•°æ®', error);
            }
        }

        // é¡µé¢åŠ è½½æ—¶åŠ è½½æ•°æ®åº“
        loadFoodTagsDatabase();

        // æ ¹æ®é£Ÿç‰©åç§°æŸ¥è¯¢æ ‡ç­¾ä¿¡æ¯
        function findFoodTags(foodName) {
            if (!foodTagsDatabase) return null;

            foodName = foodName.trim().toLowerCase();

            // æŸ¥æ‰¾åŒ¹é…çš„é£Ÿç‰©
            for (const food of foodTagsDatabase.foods) {
                // åŒ¹é…ä¸­æ–‡å
                if (food.name.zh && food.name.zh.toLowerCase().includes(foodName)) {
                    return food;
                }
                // åŒ¹é…åˆ«å
                if (food.aliases && food.aliases.some(alias =>
                    alias.toLowerCase().includes(foodName) || foodName.includes(alias.toLowerCase())
                )) {
                    return food;
                }
            }

            return null;
        }

        // ç¢³æ°´åŒ–åˆç‰©æ•°æ®åº“ï¼ˆæ¯100gå«é‡ï¼‰- ä¿ç•™ç”¨äºå‘åå…¼å®¹
        const carbsDatabase = {
            // ä¸»é£Ÿç±»
            "ç™½ç±³é¥­": 28, "ç„ç±³": 34, "ç³™ç±³": 34, "æ‚ç²®é¥­": 30,
            "ç™½é¦’å¤´": 47, "å…¨éº¦é¦’å¤´": 42,
            "ç™½é¢åŒ…": 50, "å…¨éº¦é¢åŒ…": 43,
            "é¢æ¡": 25, "èéº¦é¢": 24, "ä¹Œå†¬é¢": 21,
            "ç±³ç²‰": 26, "ç²‰ä¸": 84,
            "é¥ºå­": 20, "åŒ…å­": 28,
            "ç‰ç±³": 19, "çº¢è–¯": 24, "ç´«è–¯": 21, "åœŸè±†": 17, "å±±è¯": 13,

            // è›‹ç™½è´¨ç±»ï¼ˆä½ç¢³æ°´ï¼‰
            "é¸¡è›‹": 0.6, "é¸¡èƒ¸è‚‰": 0, "é¸¡è…¿è‚‰": 0,
            "ç‰›è‚‰": 0, "çŒªè‚‰": 0, "ç¾Šè‚‰": 0,
            "é±¼": 0, "ä¸‰æ–‡é±¼": 0, "é³•é±¼": 0, "é²ˆé±¼": 0,
            "è™¾": 1, "èƒèŸ¹": 0, "è´ç±»": 3,
            "è±†è…": 4, "è±†æµ†": 1.5, "çº³è±†": 6, "è±†è…å¹²": 5,

            // è”¬èœç±»ï¼ˆä½ç¢³æ°´ï¼‰
            "è¥¿å…°èŠ±": 7, "èŠ±èœ": 5, "ç™½èœ": 3, "é’èœ": 3,
            "è èœ": 3, "ç”Ÿèœ": 2, "èŠ¹èœ": 3,
            "ç•ªèŒ„": 4, "é»„ç“œ": 3, "èŒ„å­": 5,
            "èƒ¡èåœ": 10, "å—ç“œ": 7, "å†¬ç“œ": 3,
            "è˜‘è‡": 3, "æœ¨è€³": 6, "æµ·å¸¦": 8,
            "è±†èŠ½": 4, "èŠ¦ç¬‹": 4,

            // æ°´æœç±»ï¼ˆä¸­é«˜ç¢³æ°´ï¼‰
            "è‹¹æœ": 14, "é¦™è•‰": 23, "æ©™å­": 12,
            "è‘¡è„": 17, "è¥¿ç“œ": 8, "è‰è“": 8,
            "è“è“": 11, "çŒ•çŒ´æ¡ƒ": 14, "æ¡ƒå­": 10,
            "æ¢¨": 15, "æŸšå­": 9,

            // åšæœç±»
            "æ ¸æ¡ƒ": 10, "æä»": 20, "è…°æœ": 27,
            "èŠ±ç”Ÿ": 16, "ç“œå­": 15,

            // å…¶ä»–
            "ç‰›å¥¶": 5, "é…¸å¥¶": 5,
            "å¥¶é…ª": 2, "èŠå£«": 2
        };

        // æ ¹æ®é£Ÿç‰©åç§°ä¼°ç®—ç¢³æ°´åŒ–åˆç‰©
        function calculateCarbs(foodName) {
            foodName = foodName.trim();
            for (const [key, value] of Object.entries(carbsDatabase)) {
                if (foodName.includes(key) || key.includes(foodName)) {
                    return { food: key, carbs: value, matched: true };
                }
            }
            return { food: foodName, carbs: null, matched: false };
        }

        // åˆ†æä¸€é¤çš„ç¢³æ°´æ€»é‡
        function analyzeMealCarbs(foodsText) {
            if (!foodsText || foodsText.trim() === '') {
                return { total: 0, details: [], unknown: [] };
            }

            const foods = foodsText.split(/[,ï¼Œ\n]/).map(f => f.trim()).filter(f => f);
            let totalCarbs = 0;
            const details = [];
            const unknown = [];

            foods.forEach(food => {
                const result = calculateCarbs(food);
                if (result.matched) {
                    // å‡è®¾æ¯ä»½çº¦100g
                    totalCarbs += result.carbs;
                    details.push({ food: result.food, carbs: result.carbs });
                } else {
                    unknown.push(food);
                }
            });

            return { total: Math.round(totalCarbs), details, unknown };
        }

        // åˆ†æé£Ÿç‰©-è¡€ç³–å…³è”
        function analyzeFoodGlucoseCorrelation() {
            if (!allData || allData.length === 0) {
                return [];
            }

            const foodGlucoseMap = {}; // {food: [glucose1, glucose2, ...]}

            // æ”¶é›†æ‰€æœ‰é£Ÿç‰©å’Œå¯¹åº”çš„è¡€ç³–å€¼
            allData.forEach(day => {
                day.meals.forEach(meal => {
                    if (meal.glucose && meal.foods && meal.foods.length > 0) {
                        meal.foods.forEach(food => {
                            if (!foodGlucoseMap[food]) {
                                foodGlucoseMap[food] = [];
                            }
                            foodGlucoseMap[food].push(meal.glucose);
                        });
                    }
                });
            });

            // è®¡ç®—æ¯ç§é£Ÿç‰©çš„å¹³å‡è¡€ç³–å’Œå‡ºç°æ¬¡æ•°
            const foodInsights = [];
            for (const [food, glucoseValues] of Object.entries(foodGlucoseMap)) {
                if (glucoseValues.length >= 2) { // è‡³å°‘å‡ºç°2æ¬¡æ‰æœ‰åˆ†ææ„ä¹‰
                    const avgGlucose = glucoseValues.reduce((a, b) => a + b, 0) / glucoseValues.length;
                    const count = glucoseValues.length;
                    const highCount = glucoseValues.filter(g => g > 120).length;
                    const highRate = (highCount / count * 100).toFixed(0);

                    foodInsights.push({
                        food,
                        avgGlucose: Math.round(avgGlucose),
                        count,
                        highCount,
                        highRate: parseInt(highRate),
                        glucoseValues
                    });
                }
            }

            // æŒ‰å¹³å‡è¡€ç³–é™åºæ’åº
            foodInsights.sort((a, b) => b.avgGlucose - a.avgGlucose);

            return foodInsights;
        }

        // æ¸²æŸ“é£Ÿç‰©æ´å¯Ÿå¡ç‰‡ï¼ˆå¢å¼ºç‰ˆï¼šåŒ…å«æˆåˆ†åˆ†æï¼‰
        function renderFoodInsights() {
            const container = document.getElementById('food-insights-container');
            if (!container) return;

            const insights = analyzeFoodGlucoseCorrelation();

            if (insights.length === 0) {
                container.innerHTML = `
                    <div class="advice-card info">
                        <div class="advice-icon">ğŸ’¡</div>
                        <div>
                            <div class="advice-title">æš‚æ— ä¸ªæ€§åŒ–æ´å¯Ÿ</div>
                            <div class="advice-text">éœ€è¦è‡³å°‘è®°å½•åŒä¸€ç§é£Ÿç‰©2æ¬¡ä»¥ä¸Šæ‰èƒ½åˆ†æå…¶å¯¹è¡€ç³–çš„å½±å“ã€‚ç»§ç»­è®°å½•å§ï¼</div>
                        </div>
                    </div>
                `;
                return;
            }

            // æ˜¾ç¤ºå‰5ä¸ªæœ€é«˜è¡€ç³–çš„é£Ÿç‰©
            const topHigh = insights.slice(0, Math.min(3, insights.length));
            // æ˜¾ç¤ºå‰3ä¸ªæœ€ä½è¡€ç³–çš„é£Ÿç‰©ï¼ˆä»åå¾€å‰å–ï¼‰
            const topLow = insights.slice(-Math.min(3, insights.length)).reverse();

            let html = '';

            // é«˜è¡€ç³–è§¦å‘é£Ÿç‰©
            if (topHigh.length > 0) {
                topHigh.forEach(item => {
                    if (item.avgGlucose > 120) {
                        // è·å–ç¢³æ°´å’ŒGIä¿¡æ¯
                        const carbInfo = calculateCarbs(item.food);
                        const giInfo = giDatabase.find(g => g.name.includes(item.food) || item.food.includes(g.name));

                        let componentInfo = '';
                        if (carbInfo.matched) {
                            componentInfo += `<br>ğŸ“Š ç¢³æ°´åŒ–åˆç‰©ï¼š${carbInfo.carbs}g/100g`;
                        }
                        if (giInfo) {
                            const giLevel = giInfo.gi > 70 ? 'é«˜GI' : (giInfo.gi > 55 ? 'ä¸­GI' : 'ä½GI');
                            componentInfo += `<br>ğŸ“ˆ GIå€¼ï¼š${giInfo.gi} (${giLevel})`;
                        }

                        html += `
                            <div class="advice-card ${item.avgGlucose > 140 ? 'danger' : 'warning'}">
                                <div class="advice-icon">âš ï¸</div>
                                <div>
                                    <div class="advice-title">ã€Œ${item.food}ã€å¯èƒ½å‡ç³–è¾ƒé«˜</div>
                                    <div class="advice-text">
                                        åƒè¿‡ ${item.count} æ¬¡ï¼Œå¹³å‡é¤åè¡€ç³– <strong>${item.avgGlucose} mg/dL</strong>ï¼Œ
                                        è¶…æ ‡ç‡ ${item.highRate}%ã€‚${componentInfo}
                                        <br><strong>ğŸ’¡ å»ºè®®ï¼š</strong>å‡å°‘æ‘„å…¥é‡æˆ–æ­é…ä½GIé£Ÿç‰©ã€è›‹ç™½è´¨ã€è”¬èœã€‚
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
            }

            // ä½è¡€ç³–å‹å¥½é£Ÿç‰©
            if (topLow.length > 0) {
                topLow.forEach(item => {
                    if (item.avgGlucose <= 120) {
                        // è·å–ç¢³æ°´å’ŒGIä¿¡æ¯
                        const carbInfo = calculateCarbs(item.food);
                        const giInfo = giDatabase.find(g => g.name.includes(item.food) || item.food.includes(g.name));

                        let componentInfo = '';
                        if (carbInfo.matched) {
                            componentInfo += `<br>ğŸ“Š ç¢³æ°´åŒ–åˆç‰©ï¼š${carbInfo.carbs}g/100g`;
                        }
                        if (giInfo) {
                            const giLevel = giInfo.gi > 70 ? 'é«˜GI' : (giInfo.gi > 55 ? 'ä¸­GI' : 'ä½GI');
                            componentInfo += `<br>ğŸ“ˆ GIå€¼ï¼š${giInfo.gi} (${giLevel})`;
                        }

                        html += `
                            <div class="advice-card success">
                                <div class="advice-icon">âœ…</div>
                                <div>
                                    <div class="advice-title">ã€Œ${item.food}ã€å¯¹æ‚¨å¾ˆå‹å¥½</div>
                                    <div class="advice-text">
                                        åƒè¿‡ ${item.count} æ¬¡ï¼Œå¹³å‡é¤åè¡€ç³– <strong>${item.avgGlucose} mg/dL</strong>ï¼Œ
                                        æ§ç³–æ•ˆæœå¾ˆå¥½ï¼${componentInfo}
                                        <br><strong>ğŸ’¡ å»ºè®®ï¼š</strong>å¯ä»¥ç»§ç»­ä¿æŒï¼Œè¿™æ˜¯æ‚¨çš„å®‰å…¨é£Ÿç‰©ã€‚
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
            }

            container.innerHTML = html || `
                <div class="advice-card info">
                    <div class="advice-icon">ğŸ’¡</div>
                    <div>
                        <div class="advice-title">æ•°æ®åˆ†æä¸­</div>
                        <div class="advice-text">ç»§ç»­è®°å½•æ›´å¤šæ•°æ®ï¼Œæˆ‘ä»¬ä¼šä¸ºæ‚¨å‘ç°ä¸ªæ€§åŒ–çš„é£Ÿç‰©-è¡€ç³–è§„å¾‹ã€‚</div>
                    </div>
                </div>
            `;
        }

        // æ›´æ–°ç¢³æ°´æç¤ºï¼ˆå®æ—¶è®¡ç®—ï¼‰
        function updateCarbsHint(mealType) {
            const foodsInput = document.getElementById(`${mealType}-foods`);
            const hintDiv = document.getElementById(`${mealType}-carbs-hint`);
            const valueSpan = document.getElementById(`${mealType}-carbs-value`);

            if (!foodsInput || !hintDiv || !valueSpan) return;

            const inputValue = foodsInput.value.trim();
            if (!inputValue) {
                hintDiv.style.display = 'none';
                return;
            }

            // è§£æé£Ÿç‰©åˆ—è¡¨
            const foods = inputValue.split(/[ã€,ï¼Œ]/).map(f => f.trim()).filter(f => f);

            if (foods.length === 0) {
                hintDiv.style.display = 'none';
                return;
            }

            // ç”Ÿæˆé£Ÿç‰©æ ‡ç­¾æ˜¾ç¤º
            let htmlContent = '<div style="margin-top:8px;">';
            let totalCarbs = 0;

            foods.forEach(foodName => {
                const foodData = findFoodTags(foodName);

                if (foodData) {
                    const carbs = foodData.nutrition.carbs || 0;
                    totalCarbs += carbs;

                    // ç”Ÿæˆæ ‡ç­¾HTML
                    const tagsHTML = foodData.tags.map(tag =>
                        `<span style="display:inline-block;padding:2px 6px;margin:0 4px 4px 0;background:${tag.color}22;color:${tag.color};border:1px solid ${tag.color}44;border-radius:4px;font-size:0.7rem;">${tag.icon} ${tag.label}</span>`
                    ).join('');

                    htmlContent += `
                        <div style="margin-bottom:8px;padding:8px;background:#fff;border-radius:6px;border:1px solid #e0e0e0;">
                            <div style="font-weight:600;color:#333;margin-bottom:4px;">
                                ${foodData.categoryIcon} ${foodData.name.zh}
                            </div>
                            <div style="margin-bottom:4px;">${tagsHTML}</div>
                            <div style="font-size:0.75rem;color:#666;">
                                ğŸ“Š ç¢³æ°´ï¼š${carbs}g/100g | è›‹ç™½è´¨ï¼š${foodData.nutrition.protein || 0}g/100g
                            </div>
                            <div style="font-size:0.75rem;color:#888;margin-top:4px;">
                                ${foodData.recommendation.emoji} ${foodData.recommendation.reason}
                            </div>
                        </div>
                    `;
                } else {
                    // ä½¿ç”¨æ—§çš„carbsDatabaseä½œä¸ºåå¤‡
                    const carbsInfo = calculateCarbs(foodName);
                    if (carbsInfo.matched) {
                        totalCarbs += carbsInfo.carbs;
                        htmlContent += `
                            <div style="margin-bottom:6px;padding:6px;background:#f5f5f5;border-radius:4px;font-size:0.8rem;color:#666;">
                                ğŸ½ï¸ ${carbsInfo.food}ï¼šçº¦${carbsInfo.carbs}gç¢³æ°´/100g
                            </div>
                        `;
                    }
                }
            });

            // æ·»åŠ æ€»ç¢³æ°´æç¤º
            let totalHint = '';
            if (mealType === 'breakfast' && totalCarbs > 30) {
                totalHint = `<span style="color:#ff9800;">âš ï¸ æ—©é¤å»ºè®®<30g</span>`;
            } else if ((mealType === 'lunch' || mealType === 'dinner') && totalCarbs > 60) {
                totalHint = `<span style="color:#ff9800;">âš ï¸ å»ºè®®<60g</span>`;
            } else if (totalCarbs > 0 && totalCarbs <= 15) {
                totalHint = `<span style="color:#4caf50;">âœ… æ§åˆ¶è‰¯å¥½</span>`;
            }

            htmlContent += `
                <div style="margin-top:8px;padding:8px;background:linear-gradient(135deg,#fff3e0 0%,#ffe0b2 100%);border-radius:6px;font-weight:600;color:#e65100;">
                    ğŸ’¡ æœ¬é¤æ€»ç¢³æ°´ï¼šçº¦${totalCarbs.toFixed(1)}g ${totalHint}
                </div>
            `;

            htmlContent += '</div>';

            valueSpan.innerHTML = htmlContent;
            hintDiv.style.display = 'block';
        }

        // GIæ•°æ®åº“
        const giDatabase = [
            { name: "ç™½ç±³é¥­", category: "ä¸»é£Ÿ", gi: 83, gl: 23, icon: "ğŸš" },
            { name: "ç„ç±³/ç³™ç±³", category: "ä¸»é£Ÿ", gi: 55, gl: 16, icon: "ğŸš" },
            { name: "æ‚ç²®é¥­", category: "ä¸»é£Ÿ", gi: 55, gl: 15, icon: "ğŸš" },
            { name: "ç™½é¦’å¤´", category: "ä¸»é£Ÿ", gi: 88, gl: 42, icon: "ğŸ¥–" },
            { name: "ç™½é¢åŒ…", category: "ä¸»é£Ÿ", gi: 75, gl: 10, icon: "ğŸ" },
            { name: "å…¨éº¦é¢åŒ…", category: "ä¸»é£Ÿ", gi: 51, gl: 7, icon: "ğŸ" },
            { name: "é¥ºå­", category: "ä¸»é£Ÿ", gi: 60, gl: 14, icon: "ğŸ¥Ÿ" },
            { name: "é¢æ¡", category: "ä¸»é£Ÿ", gi: 55, gl: 18, icon: "ğŸœ" },
            { name: "ç±³ç²‰", category: "ä¸»é£Ÿ", gi: 58, gl: 15, icon: "ğŸœ" },
            { name: "è›‹åŒ…é¥­", category: "ä¸»é£Ÿ", gi: 70, gl: 20, icon: "ğŸ³" },
            { name: "é¸¡è‚‰", category: "è›‹ç™½è´¨", gi: 0, gl: 0, icon: "ğŸ—" },
            { name: "é±¼è‚‰", category: "è›‹ç™½è´¨", gi: 0, gl: 0, icon: "ğŸŸ" },
            { name: "ç‰›è‚‰", category: "è›‹ç™½è´¨", gi: 0, gl: 0, icon: "ğŸ¥©" },
            { name: "é¸¡è›‹", category: "è›‹ç™½è´¨", gi: 0, gl: 0, icon: "ğŸ¥š" },
            { name: "è±†è…", category: "è›‹ç™½è´¨", gi: 42, gl: 1, icon: "ğŸ§Š" },
            { name: "çº³è±†", category: "è›‹ç™½è´¨", gi: 33, gl: 2, icon: "ğŸ«˜" },
            { name: "è¥¿å…°èŠ±", category: "è”¬èœ", gi: 15, gl: 1, icon: "ğŸ¥¦" },
            { name: "é»„ç“œ", category: "è”¬èœ", gi: 15, gl: 0, icon: "ğŸ¥’" },
            { name: "è¥¿çº¢æŸ¿", category: "è”¬èœ", gi: 30, gl: 1, icon: "ğŸ…" },
            { name: "èŒ„å­", category: "è”¬èœ", gi: 25, gl: 1, icon: "ğŸ†" },
            { name: "è‹¹æœ", category: "æ°´æœ", gi: 36, gl: 5, icon: "ğŸ" },
            { name: "æ©™å­", category: "æ°´æœ", gi: 43, gl: 5, icon: "ğŸŠ" },
            { name: "å¥‡å¼‚æœ", category: "æ°´æœ", gi: 35, gl: 4, icon: "ğŸ¥" },
            { name: "é¥¼å¹²", category: "é›¶é£Ÿ", gi: 77, gl: 14, icon: "ğŸª" },
            { name: "ç‰›å¥¶", category: "é¥®å“", gi: 27, gl: 3, icon: "ğŸ¥›" },
            { name: "è±†æµ†", category: "é¥®å“", gi: 30, gl: 2, icon: "ğŸ¥›" }
        ];
        
        let selectedDateIndex = 0;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ä¿®æ­£selectedDateIndex
            if (allData && allData.length > 0) {
                selectedDateIndex = allData.length - 1;
            } else {
                selectedDateIndex = 0;
            }

            // åˆå§‹åŒ–Google Drive
            loadGoogleDriveState();
            initGoogleAPI();

            // å»¶è¿Ÿæ£€æŸ¥äº‘ç«¯æ›´æ–°ï¼ˆç­‰å¾…APIåˆå§‹åŒ–å®Œæˆï¼‰
            setTimeout(() => {
                autoRestoreFromDrive().catch(err => {
                    console.warn('è‡ªåŠ¨æ¢å¤æ£€æŸ¥å¤±è´¥:', err);
                });
            }, 2000);

            renderDateSelector();
            renderDayData(selectedDateIndex);
            renderGIDatabase();
            renderWeekTable();
            initChart();
            setupEventListeners();
            updateNotificationButton();
            renderFoodInsights();
        });
        
        function renderDateSelector() {
            const selector = document.getElementById('date-selector');
            if (!allData || allData.length === 0) {
                selector.innerHTML = `<div style="text-align:center;padding:12px;color:var(--text-light);font-size:0.85rem;">æš‚æ— è®°å½•</div>`;
                return;
            }
            selector.innerHTML = allData.map((day, i) => `
                <div class="date-item ${i === selectedDateIndex ? 'active' : ''} ${day.meals.length > 0 ? 'has-data' : ''}" onclick="selectDate(${i})">
                    <div class="date-weekday">${day.weekday}</div>
                    <div class="date-day">${day.date.replace('12æœˆ','').replace('æ—¥','')}</div>
                </div>
            `).join('');
            setTimeout(() => {
                const active = selector.querySelector('.date-item.active');
                if (active) active.scrollIntoView({ behavior: 'smooth', inline: 'center' });
            }, 100);
        }
        
        function selectDate(index) {
            selectedDateIndex = index;
            renderDateSelector();
            renderDayData(index);
        }
        
        function renderDayData(index) {
            // å¤„ç†ç©ºæ•°æ®æƒ…å†µï¼ˆæ–°ç”¨æˆ·é¦–æ¬¡ä½¿ç”¨ï¼‰
            if (!allData || allData.length === 0) {
                const today = new Date();
                const dateStr = `${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;
                const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
                const weekday = weekdays[today.getDay()];

                document.getElementById('current-date').textContent = `2025å¹´${dateStr} ${weekday}`;
                document.getElementById('weight-display').innerHTML = `--<span class="unit">kg</span>`;
                document.getElementById('steps-display').innerHTML = `--<span class="unit">æ­¥</span>`;

                // æ˜¾ç¤ºæ–°æ‰‹å¼•å¯¼
                const mealCards = document.getElementById('meal-cards');
                if (mealCards) {
                    mealCards.innerHTML = `
                        <div style="text-align:center;padding:40px 20px;color:var(--text-light);">
                            <div style="font-size:3rem;margin-bottom:16px;">ğŸ‘‹</div>
                            <div style="font-size:1.2rem;font-weight:600;color:var(--text);margin-bottom:12px;">æ¬¢è¿ä½¿ç”¨ç³–å¦ˆæ—¥è®°ï¼</div>
                            <div style="margin-bottom:20px;line-height:1.6;">
                                è¿™æ˜¯ä¸€æ¬¾ä¸“ä¸ºå¦Šå¨ æœŸç³–å°¿ç—…ï¼ˆGDMï¼‰å­•å¦‡è®¾è®¡çš„é¥®é£Ÿå’Œè¡€ç³–ç®¡ç†å·¥å…·
                            </div>
                            <div style="background:var(--primary-light);border-radius:12px;padding:16px;margin-bottom:16px;text-align:left;">
                                <div style="font-weight:600;color:var(--primary-dark);margin-bottom:8px;">âœ¨ å¿«é€Ÿå¼€å§‹ï¼š</div>
                                <div style="color:var(--text);font-size:0.9rem;line-height:1.8;">
                                    1ï¸âƒ£ ç‚¹å‡»åº•éƒ¨ <strong>+</strong> æŒ‰é’®æ·»åŠ ä»Šæ—¥è®°å½•<br>
                                    2ï¸âƒ£ å¡«å†™æ—©/åˆ/æ™šé¤çš„é£Ÿç‰©å’Œè¡€ç³–å€¼<br>
                                    3ï¸âƒ£ æŸ¥çœ‹æ™ºèƒ½æ ‡ç­¾å’Œè¥å…»åˆ†æ
                                </div>
                            </div>
                            <button onclick="showModal('add-meal-modal')" style="background:var(--primary);color:white;border:none;padding:14px 32px;border-radius:12px;font-size:1rem;font-weight:600;cursor:pointer;margin-bottom:12px;">
                                ğŸ“ æ·»åŠ ç¬¬ä¸€æ¡è®°å½•
                            </button>
                            <div style="margin-top:12px;">
                                <button onclick="loadSampleData()" style="background:white;color:var(--primary);border:2px solid var(--primary);padding:10px 24px;border-radius:10px;font-size:0.9rem;cursor:pointer;">
                                    ğŸ“Š åŠ è½½ç¤ºä¾‹æ•°æ®æŸ¥çœ‹æ•ˆæœ
                                </button>
                            </div>
                        </div>
                    `;
                }

                const summaryDiv = document.getElementById('advice-cards');
                if (summaryDiv) {
                    summaryDiv.innerHTML = '';
                }
                return;
            }

            const day = allData[index];
            document.getElementById('current-date').textContent = `2025å¹´${day.date} ${day.weekday}`;
            document.getElementById('weight-display').innerHTML = day.weight ? `${day.weight}<span class="unit">kg</span>` : `--<span class="unit">kg</span>`;
            document.getElementById('steps-display').innerHTML = day.steps ? `${day.steps}<span class="unit">æ­¥</span>` : `--<span class="unit">æ­¥</span>`;
            renderMealCards(day);
            renderDailySummary(day);
            renderAdvice(day);
        }
        
        function renderMealCards(day) {
            const container = document.getElementById('meal-cards');
            const mealTypes = { breakfast: { name: 'æ—©é¤', icon: 'ğŸŒ…', class: 'breakfast' }, lunch: { name: 'åˆé¤', icon: 'â˜€ï¸', class: 'lunch' }, dinner: { name: 'æ™šé¤', icon: 'ğŸŒ™', class: 'dinner' } };
            const meals = day.meals.filter(m => m.type !== 'snack');
            if (meals.length === 0) {
                container.innerHTML = `<div style="text-align:center;padding:30px;color:var(--text-light);"><div style="font-size:2.5rem;margin-bottom:10px;">ğŸ“</div><div>ä»Šå¤©è¿˜æ²¡æœ‰è®°å½•</div></div>`;
                return;
            }
            container.innerHTML = meals.map(meal => {
                const info = mealTypes[meal.type] || mealTypes.breakfast;
                const cls = getGlucoseClass(meal.glucose);

                // ä½¿ç”¨æ–°çš„é£Ÿç‰©æ ‡ç­¾æ•°æ®åº“ç”Ÿæˆä¸°å¯Œçš„æ ‡ç­¾æ˜¾ç¤º
                const foodTags = meal.foods.map(f => {
                    const foodData = findFoodTags(f);

                    if (foodData) {
                        // ä½¿ç”¨æ–°æ•°æ®åº“çš„ä¸°å¯Œæ ‡ç­¾
                        const tagsHTML = foodData.tags.map(tag =>
                            `<span style="display:inline-block;padding:2px 5px;margin:0 2px;background:${tag.color}22;color:${tag.color};border:1px solid ${tag.color}44;border-radius:3px;font-size:0.65rem;">${tag.icon}</span>`
                        ).join('');
                        return `<span class="food-tag" style="display:inline-flex;align-items:center;gap:4px;">${foodData.categoryIcon} ${f}${tagsHTML}</span>`;
                    } else {
                        // åå¤‡æ–¹æ¡ˆï¼šä½¿ç”¨æ—§çš„giDatabase
                        const gi = giDatabase.find(g => f.includes(g.name));
                        let giCls = 'low';
                        if (gi && gi.gi > 70) giCls = 'high';
                        else if (gi && gi.gi > 55) giCls = 'medium';
                        return `<span class="food-tag"><span class="gi-dot ${giCls}"></span>${f}</span>`;
                    }
                }).join('');

                const avgGI = calculateMealGI(meal.foods);
                const carbs = estimateCarbs(meal.foods);
                return `
                    <div class="meal-card">
                        <div class="meal-header">
                            <div class="meal-info">
                                <div class="meal-icon ${info.class}">${info.icon}</div>
                                <div><div class="meal-name">${info.name}</div><div class="meal-time">${meal.time} è¿›é¤</div></div>
                            </div>
                            <div style="text-align:right;">
                                ${meal.glucose ? `<div class="glucose-value ${cls}">${meal.glucose}</div><div class="glucose-label">é¤åè¡€ç³–</div>` : `<div class="glucose-value" style="color:var(--text-light);">--</div><div class="glucose-label">æœªæµ‹é‡</div>`}
                            </div>
                        </div>
                        <div class="meal-foods"><div class="food-tags">${foodTags}</div></div>
                        <div class="meal-analysis">
                            <div class="analysis-item"><div class="analysis-value" style="color:${avgGI > 60 ? 'var(--warning)' : 'var(--success)'};">${avgGI}</div><div class="analysis-label">GIå‡å€¼</div></div>
                            <div class="analysis-item"><div class="analysis-value">${carbs}g</div><div class="analysis-label">ä¼°ç®—ç¢³æ°´</div></div>
                            <div class="analysis-item"><div class="analysis-value" style="color:${meal.glucose && meal.glucose <= 120 ? 'var(--success)' : 'var(--danger)'};">${meal.glucose ? (meal.glucose <= 120 ? 'âœ“' : 'âœ—') : '-'}</div><div class="analysis-label">è¾¾æ ‡</div></div>
                        </div>
                        <div style="display:flex;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid var(--border);">
                            <button onclick="editMealRecord(${index}, '${meal.type}')" style="flex:1;padding:8px;background:var(--primary-light);color:var(--primary);border:1px solid var(--primary);border-radius:8px;font-size:0.85rem;cursor:pointer;">
                                âœï¸ ç¼–è¾‘
                            </button>
                            <button onclick="deleteMealRecord(${index}, '${meal.type}')" style="flex:1;padding:8px;background:var(--danger-light);color:var(--danger);border:1px solid var(--danger);border-radius:8px;font-size:0.85rem;cursor:pointer;">
                                ğŸ—‘ï¸ åˆ é™¤
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function calculateMealGI(foods) {
            let total = 0, count = 0;
            foods.forEach(f => {
                const gi = giDatabase.find(g => f.includes(g.name));
                if (gi && gi.gi > 0) { total += gi.gi; count++; }
            });
            return count > 0 ? Math.round(total / count) : 45;
        }
        
        function estimateCarbs(foods) {
            let carbs = 0;
            foods.forEach(f => {
                if (f.includes('é¥­') || f.includes('ç±³')) carbs += 40;
                else if (f.includes('é¢') || f.includes('é¦’å¤´')) carbs += 35;
                else if (f.includes('é¥ºå­')) carbs += 25;
                else if (f.includes('é¢åŒ…')) carbs += 20;
                else if (f.includes('æ©™') || f.includes('æ©˜') || f.includes('æœ')) carbs += 15;
                else if (f.includes('é¥¼å¹²')) carbs += 15;
            });
            return carbs || 30;
        }
        
        function getGlucoseClass(g) {
            if (!g) return '';
            if (g <= 120) return 'normal';
            if (g <= 130) return 'warning';
            return 'high';
        }
        
        function renderDailySummary(day) {
            const meals = day.meals.filter(m => m.glucose);
            const normal = meals.filter(m => m.glucose <= 120).length;
            const high = meals.filter(m => m.glucose > 120).length;
            document.getElementById('summary-meals').textContent = meals.length;
            document.getElementById('summary-normal').textContent = normal;
            document.getElementById('summary-high').textContent = high;
            const badge = document.getElementById('summary-badge');
            if (high === 0 && meals.length > 0) { badge.textContent = 'ä¼˜ç§€ â­'; badge.style.background = 'rgba(78,205,196,0.3)'; }
            else if (high <= 1) { badge.textContent = 'è‰¯å¥½'; badge.style.background = 'rgba(255,179,71,0.3)'; }
            else { badge.textContent = 'éœ€å…³æ³¨'; badge.style.background = 'rgba(255,107,107,0.3)'; }
        }
        
        function renderAdvice(day) {
            const container = document.getElementById('advice-cards');
            const advices = [];
            const breakfast = day.meals.find(m => m.type === 'breakfast');
            if (breakfast && breakfast.glucose > 120) {
                advices.push({ type: 'warning', icon: 'ğŸ³', title: 'æ—©é¤è¡€ç³–åé«˜', text: 'æ—©é¤ç¢³æ°´å¯èƒ½è¿‡å¤šï¼Œå»ºè®®å‡å°‘é¥ºå­/é¢åŒ…é‡ï¼Œæˆ–æ›¿æ¢ä¸ºä½GIé£Ÿç‰©ã€‚' });
            }
            const dinner = day.meals.find(m => m.type === 'dinner');
            if (dinner && dinner.glucose && dinner.glucose <= 110) {
                advices.push({ type: 'success', icon: 'ğŸŒ™', title: 'æ™šé¤æ§åˆ¶ä¼˜ç§€', text: 'è¡€ç³–æ§åˆ¶åœ¨110ä»¥ä¸‹ï¼Œç»§ç»­ä¿æŒè›‹ç™½è´¨+è”¬èœ+æ‚ç²®çš„æ­é…ï¼' });
            }
            if (day.steps && day.steps < 6000) {
                advices.push({ type: 'danger', icon: 'ğŸš¶', title: 'è¿åŠ¨ä¸è¶³', text: `ä»Šæ—¥${day.steps}æ­¥ï¼Œæœªè¾¾6000æ­¥ç›®æ ‡ã€‚å»ºè®®é¤åæ•£æ­¥15-20åˆ†é’Ÿã€‚` });
            } else if (day.steps && day.steps >= 6000) {
                advices.push({ type: 'success', icon: 'ğŸ‘', title: 'è¿åŠ¨è¾¾æ ‡', text: `ä»Šæ—¥${day.steps}æ­¥ï¼Œå·²è¾¾æ ‡ï¼é¤åè¿åŠ¨å¯¹è¡€ç³–å¸®åŠ©å¾ˆå¤§ã€‚` });
            }
            if (day.notes && day.notes.includes('é»‘ä¾¿')) {
                advices.push({ type: 'info', icon: 'âš ï¸', title: 'å…³æ³¨æ’ä¾¿', text: 'å‡ºç°é»‘è‰²å¤§ä¾¿ï¼Œå¯èƒ½ä¸è¡¥é“å‰‚æœ‰å…³ã€‚å¦‚æŒç»­è¯·å’¨è¯¢åŒ»ç”Ÿã€‚' });
            }
            if (advices.length === 0) {
                advices.push({ type: 'info', icon: 'ğŸ’¡', title: 'è¿›é¤æç¤º', text: 'è®°å¾—ä¿æŒ"å…ˆè”¬èœâ†’è›‹ç™½è´¨â†’ä¸»é£Ÿ"çš„è¿›é¤é¡ºåºã€‚' });
            }
            container.innerHTML = advices.map(a => `
                <div class="advice-card ${a.type}">
                    <div class="advice-icon">${a.icon}</div>
                    <div><div class="advice-title">${a.title}</div><div class="advice-text">${a.text}</div></div>
                </div>
            `).join('');
        }
        
        function renderGIDatabase() {
            const input = document.getElementById('gi-search-input');
            const results = document.getElementById('gi-results');
            const common = document.getElementById('common-foods');
            renderGIResults(common, giDatabase.slice(0, 8));
            input.addEventListener('input', function() {
                const q = this.value.toLowerCase();
                if (q.length === 0) { results.innerHTML = ''; return; }
                const r = giDatabase.filter(f => f.name.toLowerCase().includes(q) || f.category.includes(q));
                renderGIResults(results, r);
            });
        }
        
        function renderGIResults(container, items) {
            if (items.length === 0) { container.innerHTML = '<div style="text-align:center;padding:16px;color:var(--text-light);">æœªæ‰¾åˆ°</div>'; return; }
            container.innerHTML = items.map(f => {
                let cls = 'low';
                if (f.gi > 70) cls = 'high';
                else if (f.gi > 55) cls = 'medium';
                return `
                    <div class="gi-result-item">
                        <div class="gi-food-info">
                            <div class="gi-food-icon ${cls}">${f.icon}</div>
                            <div><div class="gi-food-name">${f.name}</div><div class="gi-food-category">${f.category}</div></div>
                        </div>
                        <div style="text-align:right;"><div class="gi-value ${cls}">GI ${f.gi}</div><div class="gl-value">GL ${f.gl}</div></div>
                    </div>
                `;
            }).join('');
        }
        
        function renderWeekTable() {
            const tbody = document.getElementById('week-table-body');
            if (!allData || allData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--text-light);">æš‚æ— è®°å½•</td></tr>';
                return;
            }
            tbody.innerHTML = allData.map(d => {
                const b = d.meals.find(m => m.type === 'breakfast');
                const l = d.meals.find(m => m.type === 'lunch');
                const di = d.meals.find(m => m.type === 'dinner');
                const cell = m => m && m.glucose ? `<td class="glucose-cell ${getGlucoseClass(m.glucose)}">${m.glucose}</td>` : '<td>-</td>';
                return `<tr><td>${d.date.replace('12æœˆ','').replace('æ—¥','')}æ—¥</td><td>${d.weight || '-'}</td>${cell(b)}${cell(l)}${cell(di)}<td>${d.steps || '-'}</td></tr>`;
            }).join('');
        }
        
        function initChart() {
            const ctx = document.getElementById('glucose-chart');
            if (!ctx) return;

            // é”€æ¯å·²æœ‰çš„å›¾è¡¨å®ä¾‹
            if (ctx.chart) {
                ctx.chart.destroy();
                ctx.chart = null;
            }

            if (!allData || allData.length === 0) {
                // æ˜¾ç¤ºç©ºæ•°æ®æç¤º
                ctx.style.display = 'none';
                const parent = ctx.parentElement;
                if (parent && !parent.querySelector('.empty-chart-message')) {
                    const emptyMsg = document.createElement('div');
                    emptyMsg.className = 'empty-chart-message';
                    emptyMsg.style.cssText = 'text-align:center;padding:40px;color:var(--text-light);';
                    emptyMsg.textContent = 'æš‚æ— æ•°æ®';
                    parent.appendChild(emptyMsg);
                }
                calculateMealAverages();
                return;
            }

            // ç§»é™¤ç©ºæ•°æ®æç¤º
            const parent = ctx.parentElement;
            if (parent) {
                const emptyMsg = parent.querySelector('.empty-chart-message');
                if (emptyMsg) emptyMsg.remove();
            }

            const labels = [], data = [], colors = [];
            allData.forEach(d => {
                d.meals.forEach(m => {
                    if (m.glucose) {
                        labels.push(d.date.replace('12æœˆ','').replace('æ—¥','') + (m.type === 'breakfast' ? 'æ—©' : m.type === 'lunch' ? 'åˆ' : 'æ™š'));
                        data.push(m.glucose);
                        colors.push(m.glucose <= 120 ? 'rgba(78,205,196,0.8)' : 'rgba(255,107,107,0.8)');
                    }
                });
            });

            if (data.length === 0) {
                ctx.style.display = 'none';
                if (parent && !parent.querySelector('.empty-chart-message')) {
                    const emptyMsg = document.createElement('div');
                    emptyMsg.className = 'empty-chart-message';
                    emptyMsg.style.cssText = 'text-align:center;padding:40px;color:var(--text-light);';
                    emptyMsg.textContent = 'æš‚æ— è¡€ç³–æ•°æ®';
                    parent.appendChild(emptyMsg);
                }
                calculateMealAverages();
                return;
            }

            // æ˜¾ç¤ºcanvaså¹¶åˆ›å»ºå›¾è¡¨
            ctx.style.display = 'block';
            ctx.chart = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ data, backgroundColor: colors, borderRadius: 4 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { min: 80, max: 150 }, x: { ticks: { font: { size: 8 }, maxRotation: 45 } } }
                }
            });
            calculateMealAverages();
        }
        
        function calculateMealAverages() {
            if (!allData || allData.length === 0) {
                document.getElementById('breakfast-avg').textContent = '--';
                document.getElementById('lunch-avg').textContent = '--';
                document.getElementById('dinner-avg').textContent = '--';
                document.getElementById('compliance-rate').textContent = '--%';
                document.getElementById('avg-glucose').innerHTML = '--<span class="unit">mg/dL</span>';
                return;
            }

            const b = [], l = [], d = [];
            allData.forEach(day => day.meals.forEach(m => {
                if (m.glucose) {
                    if (m.type === 'breakfast') b.push(m.glucose);
                    else if (m.type === 'lunch') l.push(m.glucose);
                    else if (m.type === 'dinner') d.push(m.glucose);
                }
            }));
            const avg = arr => arr.length ? Math.round(arr.reduce((a, c) => a + c, 0) / arr.length) : 0;
            document.getElementById('breakfast-avg').textContent = avg(b) || '--';
            document.getElementById('lunch-avg').textContent = avg(l) || '--';
            document.getElementById('dinner-avg').textContent = avg(d) || '--';
            const all = [...b, ...l, ...d];
            const normal = all.filter(g => g <= 120).length;
            document.getElementById('compliance-rate').textContent = all.length ? Math.round((normal / all.length) * 100) + '%' : '--%';
            document.getElementById('avg-glucose').innerHTML = (avg(all) || '--') + '<span class="unit">mg/dL</span>';
        }
        
        // ä¸€æ¬¡æ€§ä¿å­˜å½“å¤©æ‰€æœ‰æ•°æ®
        function saveAllDayData() {
            const dateInput = document.getElementById('record-date-input').value;
            if (!dateInput) {
                alert('âŒ è¯·é€‰æ‹©æ—¥æœŸ');
                return;
            }

            const selectedDate = new Date(dateInput);
            const dateStr = `${selectedDate.getMonth() + 1}æœˆ${selectedDate.getDate()}æ—¥`;
            const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            const weekday = weekdays[selectedDate.getDay()];

            // æŸ¥æ‰¾æˆ–åˆ›å»ºè¯¥æ—¥æœŸçš„è®°å½•
            let dateIndex = allData.findIndex(d => d.date === dateStr);
            if (dateIndex === -1) {
                allData.push({
                    date: dateStr,
                    weekday: weekday,
                    weight: null,
                    fasting: null,
                    steps: null,
                    meals: [],
                    notes: null,
                    year: selectedDate.getFullYear()
                });
                dateIndex = allData.length - 1;
                console.log(`ğŸ“… åˆ›å»ºæ–°æ—¥æœŸè®°å½•: ${dateStr} ${weekday}`);
            }

            // ä¿å­˜æ¯æ—¥æ•°æ®
            const weight = document.getElementById('weight-input').value;
            const fasting = document.getElementById('fasting-input').value;
            const steps = document.getElementById('steps-input').value;
            const notes = document.getElementById('notes-input').value.trim();

            if (weight) allData[dateIndex].weight = parseFloat(weight);
            if (fasting) allData[dateIndex].fasting = parseInt(fasting);
            if (steps) allData[dateIndex].steps = parseInt(steps);
            if (notes) allData[dateIndex].notes = notes;

            // ä¿å­˜ä¸‰é¤æ•°æ®
            const meals = [
                {
                    type: 'breakfast',
                    foodsId: 'breakfast-foods',
                    glucoseId: 'breakfast-glucose',
                    timeId: 'breakfast-time'
                },
                {
                    type: 'lunch',
                    foodsId: 'lunch-foods',
                    glucoseId: 'lunch-glucose',
                    timeId: 'lunch-time'
                },
                {
                    type: 'dinner',
                    foodsId: 'dinner-foods',
                    glucoseId: 'dinner-glucose',
                    timeId: 'dinner-time'
                }
            ];

            let mealsAdded = 0;
            meals.forEach(meal => {
                const foods = document.getElementById(meal.foodsId).value.trim();
                const glucose = document.getElementById(meal.glucoseId).value;
                const time = document.getElementById(meal.timeId).value;

                // åªæœ‰å¡«å†™äº†é£Ÿç‰©æ‰ä¿å­˜è¯¥é¤
                if (foods) {
                    const foodList = foods.split(/[,ï¼Œ\n]/).map(f => f.trim()).filter(f => f);
                    const newMeal = {
                        type: meal.type,
                        time: time || '00:00',
                        foods: foodList,
                        glucose: glucose ? parseInt(glucose) : null
                    };

                    // æŸ¥æ‰¾æ˜¯å¦å·²æœ‰è¯¥é¤æ¬¡è®°å½•
                    const existingMealIndex = allData[dateIndex].meals.findIndex(m => m.type === meal.type);
                    if (existingMealIndex >= 0) {
                        allData[dateIndex].meals[existingMealIndex] = newMeal;
                    } else {
                        allData[dateIndex].meals.push(newMeal);
                    }

                    mealsAdded++;

                    // å¦‚æœæ²¡æœ‰å¡«å†™è¡€ç³–å€¼ä¸”æœ‰æ—¶é—´ï¼Œè®¾ç½®é¤åæé†’
                    if (!glucose && time && time !== '00:00') {
                        scheduleGlucoseReminder(meal.type, time, selectedDate);
                    }
                }
            });

            // ä¿å­˜åˆ° localStorage
            saveData();

            // å…³é—­æ¨¡æ€æ¡†
            hideModal('add-meal-modal');

            // é‡ç½®è¡¨å•
            resetAllDayForm();

            // é€‰ä¸­è¯¥æ—¥æœŸå¹¶åˆ·æ–°æ˜¾ç¤º
            selectedDateIndex = dateIndex;
            renderDateSelector();
            renderDayData(dateIndex);
            renderWeekTable();

            const chartElement = document.getElementById('glucose-chart');
            if (chartElement && chartElement.chart) {
                chartElement.chart.destroy();
            }
            initChart();

            // æ›´æ–°é£Ÿç‰©æ´å¯Ÿ
            renderFoodInsights();

            // å¦‚æœæ·»åŠ äº†é¤æ¬¡ä¸”æ”¯æŒé€šçŸ¥ï¼Œè¯¢é—®æ˜¯å¦å¼€å¯æé†’
            if (mealsAdded > 0 && 'Notification' in window && Notification.permission === 'default') {
                const enableReminder = confirm('ğŸ“¢ æ˜¯å¦å¼€å¯é¤åè¡€ç³–æµ‹é‡æé†’ï¼Ÿ\n\næˆ‘ä»¬ä¼šåœ¨é¤å1-2å°æ—¶æé†’æ‚¨æµ‹è¡€ç³–ã€‚');
                if (enableReminder) {
                    requestNotificationPermission();
                }
            }

            alert('âœ… è®°å½•ä¿å­˜æˆåŠŸï¼\n\nå·²ä¿å­˜è¯¥æ—¥æœŸçš„æ‰€æœ‰æ•°æ®ã€‚');
        }

        // é‡ç½®æ‰€æœ‰è¡¨å•
        function resetAllDayForm() {
            document.getElementById('weight-input').value = '';
            document.getElementById('fasting-input').value = '';
            document.getElementById('steps-input').value = '';
            document.getElementById('notes-input').value = '';
            document.getElementById('breakfast-foods').value = '';
            document.getElementById('breakfast-glucose').value = '';
            document.getElementById('breakfast-time').value = '';
            document.getElementById('lunch-foods').value = '';
            document.getElementById('lunch-glucose').value = '';
            document.getElementById('lunch-time').value = '';
            document.getElementById('dinner-foods').value = '';
            document.getElementById('dinner-glucose').value = '';
            document.getElementById('dinner-time').value = '';
        }

        // æ—§çš„ä¿å­˜å‡½æ•°ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰
        function saveRecord() {
            const recordType = document.querySelector('.record-type-btn.active').dataset.type;
            const dateInput = document.getElementById('record-date-input').value;

            if (!dateInput) {
                alert('âŒ è¯·é€‰æ‹©æ—¥æœŸ');
                return;
            }

            const selectedDate = new Date(dateInput);
            const dateStr = `${selectedDate.getMonth() + 1}æœˆ${selectedDate.getDate()}æ—¥`;
            const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            const weekday = weekdays[selectedDate.getDay()];

            // æŸ¥æ‰¾æˆ–åˆ›å»ºè¯¥æ—¥æœŸçš„è®°å½•
            let dateIndex = allData.findIndex(d => d.date === dateStr);
            if (dateIndex === -1) {
                allData.push({
                    date: dateStr,
                    weekday: weekday,
                    weight: null,
                    fasting: null,
                    steps: null,
                    meals: [],
                    notes: null,
                    year: selectedDate.getFullYear()
                });
                dateIndex = allData.length - 1;
                console.log(`ğŸ“… åˆ›å»ºæ–°æ—¥æœŸè®°å½•: ${dateStr} ${weekday}`);
            }

            if (recordType === 'meal') {
                // ä¿å­˜é¥®é£Ÿè®°å½•
                const mealType = document.querySelector('.meal-type-btn.active').dataset.type;
                const foods = document.getElementById('meal-foods-input').value.trim();
                const glucose = document.getElementById('meal-glucose-input').value;
                const time = document.getElementById('meal-time-input').value;

                if (!foods) {
                    alert('âŒ è¯·å¡«å†™é£Ÿç‰©å†…å®¹');
                    return;
                }
                if (!time) {
                    alert('âŒ è¯·é€‰æ‹©æµ‹é‡æ—¶é—´');
                    return;
                }

                const foodList = foods.split(/[,ï¼Œ\n]/).map(f => f.trim()).filter(f => f);
                const newMeal = {
                    type: mealType,
                    time: time,
                    foods: foodList,
                    glucose: glucose ? parseInt(glucose) : null
                };

                const existingMealIndex = allData[dateIndex].meals.findIndex(m => m.type === mealType);
                if (existingMealIndex >= 0) {
                    allData[dateIndex].meals[existingMealIndex] = newMeal;
                } else {
                    allData[dateIndex].meals.push(newMeal);
                }

            } else if (recordType === 'daily') {
                // ä¿å­˜æ¯æ—¥æ•°æ®
                const weight = document.getElementById('weight-input').value;
                const fasting = document.getElementById('fasting-input').value;
                const steps = document.getElementById('steps-input').value;
                const notes = document.getElementById('notes-input').value.trim();

                if (weight) allData[dateIndex].weight = parseFloat(weight);
                if (fasting) allData[dateIndex].fasting = parseInt(fasting);
                if (steps) allData[dateIndex].steps = parseInt(steps);
                if (notes) allData[dateIndex].notes = notes;
            }

            // ä¿å­˜åˆ° localStorage
            saveData();

            // å…³é—­æ¨¡æ€æ¡†
            hideModal('add-meal-modal');

            // é‡ç½®è¡¨å•
            resetRecordForm();

            // é€‰ä¸­è¯¥æ—¥æœŸå¹¶åˆ·æ–°æ˜¾ç¤º
            selectedDateIndex = dateIndex;
            renderDateSelector();
            renderDayData(dateIndex);
            renderWeekTable();

            const chartElement = document.getElementById('glucose-chart');
            if (chartElement && chartElement.chart) {
                chartElement.chart.destroy();
            }
            initChart();

            alert('âœ… è®°å½•ä¿å­˜æˆåŠŸï¼');
        }

        // é‡ç½®è¡¨å•
        function resetRecordForm() {
            document.getElementById('meal-foods-input').value = '';
            document.getElementById('meal-glucose-input').value = '';
            document.getElementById('meal-time-input').value = '';
            document.getElementById('weight-input').value = '';
            document.getElementById('fasting-input').value = '';
            document.getElementById('steps-input').value = '';
            document.getElementById('notes-input').value = '';
        }

        // æ—§çš„ä¿å­˜å‡½æ•°ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰
        function saveMealRecord() {
            // è·å–é€‰ä¸­çš„æ—¥æœŸ
            const dateInput = document.getElementById('record-date-input');
            if (!dateInput || !dateInput.value) {
                alert('âŒ è¯·é€‰æ‹©æ—¥æœŸ');
                return;
            }

            const selectedDate = new Date(dateInput.value);
            const dateStr = `${selectedDate.getMonth() + 1}æœˆ${selectedDate.getDate()}æ—¥`;
            const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            const weekday = weekdays[selectedDate.getDay()];

            // æ”¶é›†æ‰€æœ‰é¤æ¬¡æ•°æ®
            const mealsData = [];

            ['breakfast', 'lunch', 'dinner'].forEach(mealType => {
                const foods = document.getElementById(`${mealType}-foods`)?.value.trim();
                const glucose = document.getElementById(`${mealType}-glucose`)?.value;
                const time = document.getElementById(`${mealType}-time`)?.value;

                if (foods && time) {
                    const foodList = foods.split(/[,ï¼Œã€\n]/).map(f => f.trim()).filter(f => f);
                    mealsData.push({
                        type: mealType,
                        time: time,
                        foods: foodList,
                        glucose: glucose ? parseInt(glucose) : null
                    });
                }
            });

            // éªŒè¯è‡³å°‘æœ‰ä¸€é¤æ•°æ®
            if (mealsData.length === 0) {
                alert('âŒ è¯·è‡³å°‘å¡«å†™ä¸€é¤çš„é£Ÿç‰©å’Œæ—¶é—´');
                return;
            }

            // è·å–æ¯æ—¥æ•°æ®
            const weight = document.getElementById('weight-input')?.value;
            const fasting = document.getElementById('fasting-input')?.value;
            const steps = document.getElementById('steps-input')?.value;
            const notes = document.getElementById('notes-input')?.value;

            // æŸ¥æ‰¾æˆ–åˆ›å»ºè¯¥æ—¥æœŸçš„è®°å½•
            let dateIndex = allData.findIndex(d => d.date === dateStr);
            if (dateIndex === -1) {
                // åˆ›å»ºæ–°æ—¥æœŸè®°å½•
                allData.push({
                    date: dateStr,
                    weekday: weekday,
                    weight: weight ? parseFloat(weight) : null,
                    fasting: fasting ? parseInt(fasting) : null,
                    steps: steps ? parseInt(steps) : null,
                    notes: notes || null,
                    meals: [],
                    year: selectedDate.getFullYear()
                });
                dateIndex = allData.length - 1;
                console.log(`ğŸ“… åˆ›å»ºæ–°æ—¥æœŸè®°å½•: ${dateStr} ${weekday}`);
            } else {
                // æ›´æ–°æ¯æ—¥æ•°æ®
                if (weight) allData[dateIndex].weight = parseFloat(weight);
                if (fasting) allData[dateIndex].fasting = parseInt(fasting);
                if (steps) allData[dateIndex].steps = parseInt(steps);
                if (notes) allData[dateIndex].notes = notes;
            }

            // æ·»åŠ æˆ–æ›´æ–°é¤æ¬¡è®°å½•
            mealsData.forEach(meal => {
                const existingMealIndex = allData[dateIndex].meals.findIndex(m => m.type === meal.type);
                if (existingMealIndex >= 0) {
                    allData[dateIndex].meals[existingMealIndex] = meal;
                } else {
                    allData[dateIndex].meals.push(meal);
                }
            });

            // ä¿å­˜åˆ° localStorage
            saveData();

            // å…³é—­æ¨¡æ€æ¡†
            hideModal('add-meal-modal');

            // é‡ç½®è¡¨å•
            resetRecordForm();

            // åˆ‡æ¢åˆ°é¦–é¡µï¼ˆç¡®ä¿ç”¨æˆ·èƒ½çœ‹åˆ°æ–°æ·»åŠ çš„æ•°æ®ï¼‰
            showPage('page-home');

            // é€‰ä¸­è¯¥æ—¥æœŸå¹¶åˆ·æ–°æ˜¾ç¤º
            selectedDateIndex = dateIndex;
            renderDateSelector();
            renderDayData(dateIndex);
            renderWeekTable();

            // é‡æ–°åˆå§‹åŒ–å›¾è¡¨
            const chartElement = document.getElementById('glucose-chart');
            if (chartElement && chartElement.chart) {
                chartElement.chart.destroy();
            }
            initChart();

            // æ›´æ–°é£Ÿç‰©æ´å¯Ÿ
            renderFoodInsights();

            alert('âœ… è®°å½•ä¿å­˜æˆåŠŸï¼\n\nğŸ’¡ æç¤ºï¼šæ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°ï¼Œè®°å¾—å®šæœŸå¯¼å‡ºå¤‡ä»½ã€‚');
        }

        function resetRecordForm() {
            // é‡ç½®æ‰€æœ‰è¾“å…¥æ¡†
            ['breakfast', 'lunch', 'dinner'].forEach(mealType => {
                const foodsInput = document.getElementById(`${mealType}-foods`);
                const glucoseInput = document.getElementById(`${mealType}-glucose`);
                const timeInput = document.getElementById(`${mealType}-time`);
                if (foodsInput) foodsInput.value = '';
                if (glucoseInput) glucoseInput.value = '';
                if (timeInput) timeInput.value = '';
            });

            const weightInput = document.getElementById('weight-input');
            const fastingInput = document.getElementById('fasting-input');
            const stepsInput = document.getElementById('steps-input');
            const notesInput = document.getElementById('notes-input');
            if (weightInput) weightInput.value = '';
            if (fastingInput) fastingInput.value = '';
            if (stepsInput) stepsInput.value = '';
            if (notesInput) notesInput.value = '';
        }

        function setupEventListeners() {
            // è®°å½•ç±»å‹åˆ‡æ¢
            document.querySelectorAll('.record-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.record-type-btn').forEach(b => {
                        b.style.borderColor = 'var(--border)';
                        b.style.background = 'white';
                        b.classList.remove('active');
                    });
                    this.style.borderColor = 'var(--primary)';
                    this.style.background = 'var(--primary-light)';
                    this.classList.add('active');

                    // åˆ‡æ¢æ˜¾ç¤ºåŒºåŸŸ
                    const type = this.dataset.type;
                    if (type === 'meal') {
                        document.getElementById('meal-record-section').style.display = 'block';
                        document.getElementById('daily-record-section').style.display = 'none';
                    } else {
                        document.getElementById('meal-record-section').style.display = 'none';
                        document.getElementById('daily-record-section').style.display = 'block';
                    }
                });
            });

            // é¤æ¬¡é€‰æ‹©æŒ‰é’®
            document.querySelectorAll('.meal-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.meal-type-btn').forEach(b => {
                        b.style.borderColor = 'var(--border)';
                        b.style.background = 'white';
                        b.classList.remove('active');
                    });
                    this.style.borderColor = 'var(--primary)';
                    this.style.background = 'var(--primary-light)';
                    this.classList.add('active');
                });
            });
        }

        // æ‰“å¼€æ·»åŠ è®°å½•æ¨¡æ€æ¡†æ—¶è®¾ç½®é»˜è®¤å€¼
        function showModal(id) {
            document.getElementById(id).classList.add('active');
            document.body.style.overflow = 'hidden';

            if (id === 'add-meal-modal') {
                // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
                const today = new Date();
                const dateStr = today.toISOString().split('T')[0];
                document.getElementById('record-date-input').value = dateStr;
            }
        }
        
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const navId = 'nav-' + pageId.replace('page-', '');
            const nav = document.getElementById(navId);
            if (nav) nav.classList.add('active');
            window.scrollTo(0, 0);
        }

        function hideModal(id) {
            document.getElementById(id).classList.remove('active');
            document.body.style.overflow = '';
        }
        
        document.querySelectorAll('.modal-overlay').forEach(m => {
            m.addEventListener('click', function(e) { if (e.target === this) hideModal(this.id); });
        });
    </script>
</body>
</html>